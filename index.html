<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>He Is Coming   Loadout Builder (v5)</title>
<style>
html,body { margin:0; height:100%; background:#000; color:#f33; font-family: Inter, system-ui, Arial, sans-serif; }
/* Slightly smaller font for a more compact UI */
html { font-size:13px; }
header { padding:10px 16px; border-bottom:2px solid #f33; }
.frame {
  display: grid;
  grid-template-columns: 300px minmax(0, 1fr) 300px;
  gap: 6px;
  height: calc(100vh - 52px);
  padding: 6px;
  overflow: hidden;
}
.panel {
  background:#000;
  border:2px solid #f33;
  border-radius:10px;
  padding:6px;
  display:flex;
  flex-direction:column;
  min-height:0;
  overflow:auto; /* allow column to scroll instead of page */
}
.title { font-size:12px; color:#f33; margin:4px 2px 6px; }
.oils { display:flex; flex-direction:column; gap:6px; }
.oil { display:flex; align-items:center; gap:8px; border:2px solid #f33; border-radius:8px; padding:6px; cursor:pointer; }
.oil img { width:22px; height:22px; image-rendering:pixelated; }
.oil.active { background:#300; }
.weapon-slot { border:2px dashed #f33; border-radius:10px; padding:8px; text-align:center; margin:8px 0; min-height:48px; display:flex; align-items:center; justify-content:center; }
.grid12 {
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  grid-auto-rows: 60px;
  gap:6px;
  flex:1;
}
.slot { border:2px dashed #f33; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#f33; }
.slot.filled { border-style:solid; }
.slot img { width:40px; height:40px; image-rendering:pixelated; }
.weapon-slot img { width:48px; height:48px; image-rendering:pixelated; }
.edge-tile { border:2px solid #f33; border-radius:10px; padding:6px; display:flex; flex-direction:column; gap:6px; margin-bottom:8px; }
.edge-body { display:flex; align-items:center; gap:8px; }
.edge-body img { width:20px; height:20px; image-rendering:pixelated; }
.edge-tile select { flex:1; background:#000; color:#f33; border:1px solid #f33; border-radius:6px; padding:4px 6px; }
.stats { display:flex; flex-direction: column; align-items:flex-start; gap:6px; padding-top:8px; border-top:2px solid #f33; }
.stat {
  display: flex;
  align-items: center;
  gap: 10px;
  background: #2f5d1a;
  border: 2px solid #95d5b2;
  border-radius: 999px;
  padding: 8px 18px;
  font-size: 20px;
  color: #fff;
  font-weight: bold;
  box-shadow: 0 2px 8px rgba(149,213,178,0.25);
  margin-bottom: 6px;
}
.stat img {
  width: 28px;
  height: 28px;
  image-rendering: pixelated;
}
  .center {
    background: #111;
    border: 2px solid #f33;
    border-radius: 12px;
    min-height: 0; /* allow children to shrink for scrolling */
    height: 100%;
    display: flex;
    flex-direction: column;
    max-width: none; /* fill available width to avoid narrow center */
    margin: 0;
    width: 100%;
    box-sizing: border-box;
    overflow: hidden; /* inner grid scrolls */
  }
  .toolbar { display:flex; gap:8px; align-items:center; padding:8px; border-bottom:2px solid #f33; flex-wrap:wrap; }
  input[type='search'], select, button { background:#1b1216; color:#f33; border:1px solid #f33; border-radius:8px; padding:6px 10px; }
  .grid {
    flex: 1 1 auto;
    min-height: 0; /* required for child scroll in flex */
    overflow: auto; /* make the compendium the scrollable area */
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 10px;
    padding: 14px;
    justify-items: stretch;
    align-content: start;
    width: 100%;
    box-sizing: border-box;
  }

  /* Mini card styling for filled slots and weapon */
  .miniCard {
    display:flex; align-items:center; gap:8px;
    border:2px solid #f33; border-radius:12px; padding:6px 8px;
    background:#111; color:#fff; box-shadow: 0 2px 8px rgba(255,51,51,0.15);
  }
  .miniCard img { width:28px; height:28px; image-rendering:pixelated; }

  /* Advanced Compendium Styles */
  .advanced-card {
    transition: all 0.2s ease !important;
  }
  
  .advanced-card:hover {
    transform: translateY(-2px) !important;
  }
  
  .compendium-header {
    background: linear-gradient(135deg, #1a1f2e 0%, #16202d 100%);
  }
  
  .header-controls {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .control-group {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .control-group label {
    color: #f33;
    font-size: 12px;
    font-weight: 600;
  }
  
  .chip {
    background: rgba(255,255,255,0.1);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    color: #fff;
    border: 1px solid rgba(255,255,255,0.2);
  }
  
  .facet-panel {
    background: rgba(0,0,0,0.6);
    border-right: 1px solid rgba(255,255,255,0.1);
  }
  
  .facet-section {
    margin-bottom: 20px;
  }
  
  .facet-title {
    color: #f33;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 8px;
    padding: 0 8px;
  }
  
  .facet-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    margin-bottom: 2px;
    border-radius: 4px;
    transition: background 0.2s ease;
    cursor: pointer;
    font-size: 11px;
  }
  
  .facet-option:hover {
    background: rgba(255,255,255,0.05);
  }
  
  .facet-option input[type="checkbox"] {
    margin: 0;
    accent-color: #f33;
  }
  
  .facet-option .count {
    margin-left: auto;
    color: #888;
    font-size: 10px;
  }
  
  .trust-badge {
    white-space: nowrap;
  }
  
  .trigger-chip {
    white-space: nowrap;
    font-weight: 500 !important;
  }
  
  .content-view {
    background: #000;
  }
  
  #itemGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 16px;
    padding: 16px;
  }
  
  #compareContent {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }
  
  .card-actions button {
    transition: all 0.2s ease;
  }
  
  .card-actions button:hover {
    transform: scale(1.05);
  }
  .slot.filled { border-style:solid; }
  .slot.filled .miniCard .name { font-size:12px; color:#faa; }

  .card {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
    border: 2px solid #f33;
    border-radius: 16px;
    padding: 14px;
    background: #111;
    color: #fff;
    font-size: 12px;
    max-width: 420px;
    width: 100%;
    box-sizing: border-box;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(255, 51, 51, 0.2);
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 51, 51, 0.3);
    border-color: #f55;
    background: #1a1a1a;
  }

  .card[data-cat="Jewelry"] { border-color: #ffd166; box-shadow: 0 4px 12px rgba(255, 209, 102, 0.2); }
  .card[data-cat="Jewelry"]:hover { border-color: #ffe0a3; box-shadow: 0 6px 16px rgba(255, 209, 102, 0.3); }

  .card[data-cat="Tome"] { border-color: #73d2de; box-shadow: 0 4px 12px rgba(115, 210, 222, 0.2); }
  .card[data-cat="Tome"]:hover { border-color: #a1e3eb; box-shadow: 0 6px 16px rgba(115, 210, 222, 0.3); }

  .card[data-cat="Food"] { border-color: #95d5b2; box-shadow: 0 4px 12px rgba(149, 213, 178, 0.2); }
  .card[data-cat="Food"]:hover { border-color: #b7e4cc; box-shadow: 0 6px 16px rgba(149, 213, 178, 0.3); }
  .card[data-cat="Jewelry"]{ border-color:#ffd166; }
  .card[data-cat="Tome"]{ border-color:#73d2de; }
  .card[data-cat="Food"]{ border-color:#95d5b2; }
  /* Keyboard focus ring for cards */
  .card:focus-visible { outline: 2px solid #f55; outline-offset: 2px; }
  /* Clamp effect text to two lines inside cards */
  .card .effect {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  /* Optional: visible focus ring on slots for future keyboard nav */
  .slot:focus-visible { outline: 2px solid #f55; outline-offset: 3px; }
  /* Selected slot highlight */
.slot.active { box-shadow: 0 0 0 3px #f55 inset; background:#120; }
  /* Card quick actions (Add P / Add O) - REMOVED */
  .card__actions { display:none !important; }
  .card__btn { display:none !important; }
  .selIndicator { font-size: 12px; color:#faa; margin:4px 2px; }
.card .iconWrap { position:relative; }
.card .iconWrap img { width:48px; height:48px; image-rendering:pixelated; }
.card .badge { position:absolute; top:-6px; right:-6px; background:#210; border:1px solid #f33; border-radius:6px; padding:2px 4px; font-size:12px; }
.card .nameUnder { text-align:center; font-size:12px; }

/* Set bonus chips */
.setsBox { display:flex; flex-wrap:wrap; gap:6px; padding-top:8px; border-top:2px solid #f33; margin-top:8px; }
.setChip { display:inline-flex; align-items:center; gap:6px; background:#210; border:1px solid #f33; border-radius:12px; padding:4px 8px; font-size:12px; color:#faa; }
.setChip .name { font-weight:700; color:#fff; }
.setChip img { width:18px; height:18px; image-rendering:pixelated; }

/* Floating simulation panel styling */
/* Simulation panel now in center column, below compendium */
#simPanel {
  width:480px;
  margin:24px auto 0 auto;
  background:#000;
  border:2px solid #f33;
  border-radius:16px;
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:12px;
  z-index:10;
  position:static;
}
#simControls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
#simLog {
  flex:1;
  min-height:180px;
  max-height:320px;
  overflow:auto;
  background:#111;
  border:2px solid #f33;
  border-radius:12px;
  padding:14px;
  font-size:16px;
  font-family:monospace;
  color:#f66;
  white-space:pre-wrap;
}
.meta .name { font-weight:700; }
.meta .slug { font-size:12px; color:#f66; }
.meta .effect { font-size:12px; margin-top:6px; color:#faa; }
.meta .stats { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
.pill {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #2f5d1a;
  border: 2px solid #95d5b2;
  border-radius: 999px;
  padding: 8px 18px;
  font-size: 18px;
  color: #fff;
  font-weight: bold;
  box-shadow: 0 2px 8px rgba(149,213,178,0.25);
}
.pill img {
  width: 22px;
  height: 22px;
  image-rendering: pixelated;
}
.drag-over { outline:2px dashed #f33; }

#detailModal { position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:1000; }
#detailBox { background:#111; border:2px solid #f33; border-radius:12px; padding:16px; color:#f66; max-width:400px; }
#detailBox h2 { margin-top:0; }
#detailClose { background:#333; color:#f33; border:1px solid #f33; border-radius:6px; padding:2px 6px; float:right; cursor:pointer; }
#detailStats { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }

/* Battle Analysis System Styles */
.outcome-kpis .kpi-item {
  text-align: center;
  min-width: 80px;
}

.outcome-kpis .kpi-label {
  font-size: 11px;
  color: #aaa;
  text-transform: uppercase;
  font-weight: 500;
  margin-bottom: 2px;
}

.outcome-kpis .kpi-value {
  font-size: 16px;
  font-weight: bold;
  color: #fff;
}

.analysis-panel {
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  margin-bottom: 16px;
  overflow: hidden;
}

.analysis-panel-header {
  background: rgba(255, 255, 255, 0.05);
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  cursor: pointer;
}

.analysis-panel-header h3 {
  margin: 0;
  font-size: 16px;
  color: #fff;
  font-weight: 600;
}

.analysis-toggle {
  background: none;
  border: none;
  color: #aaa;
  font-size: 18px;
  cursor: pointer;
  padding: 0;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.analysis-toggle:hover {
  color: #fff;
}

.analysis-panel-content {
  padding: 16px;
  color: #ccc;
}

.analysis-panel.collapsed .analysis-panel-content {
  display: none;
}

.analysis-panel.collapsed .analysis-toggle {
  transform: rotate(90deg);
}

/* Damage Sources */
.damage-chart {
  margin-bottom: 12px;
}

.damage-bar {
  display: flex;
  align-items: center;
  margin-bottom: 6px;
  font-size: 12px;
}

.damage-bar-fill {
  height: 20px;
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
  margin-right: 8px;
  border-radius: 2px;
}

.damage-source-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 8px;
  background: rgba(255, 255, 255, 0.02);
  margin-bottom: 4px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.damage-source-item:hover {
  background: rgba(255, 255, 255, 0.05);
}

.damage-source-name {
  color: #fff;
  font-weight: 500;
}

.damage-source-value {
  color: #ff6b6b;
  font-weight: bold;
}

.damage-source-percent {
  color: #aaa;
  font-size: 11px;
  margin-left: 4px;
}

/* Status Impact */
.status-impact-item {
  margin-bottom: 12px;
  padding: 8px;
  background: rgba(255, 255, 255, 0.02);
  border-radius: 4px;
}

.status-impact-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.status-impact-name {
  font-weight: 500;
  color: #fff;
}

.status-impact-total {
  color: #4a9eff;
  font-weight: bold;
}

.status-impact-details {
  font-size: 11px;
  color: #aaa;
  line-height: 1.4;
}

/* Trigger Heatmap */
.heatmap-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 11px;
}

.heatmap-table th,
.heatmap-table td {
  border: 1px solid rgba(255, 255, 255, 0.1);
  padding: 6px 4px;
  text-align: center;
}

.heatmap-table th {
  background: rgba(255, 255, 255, 0.05);
  color: #fff;
  font-weight: 500;
}

.heatmap-cell {
  background: rgba(74, 158, 255, 0.1);
  color: #4a9eff;
  cursor: pointer;
  transition: background 0.2s;
}

.heatmap-cell:hover {
  background: rgba(74, 158, 255, 0.2);
}

.heatmap-cell.dead {
  background: rgba(255, 107, 107, 0.1);
  color: #666;
}

/* Synergy Tags */
.synergy-callout {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  background: rgba(156, 136, 255, 0.1);
  border: 1px solid rgba(156, 136, 255, 0.3);
  border-radius: 6px;
  margin-bottom: 8px;
  font-size: 12px;
}

.synergy-callout-icon {
  font-size: 16px;
}

.synergy-callout-text {
  flex: 1;
  color: #9c88ff;
}

.anti-synergy-warning {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  background: rgba(255, 107, 107, 0.1);
  border: 1px solid rgba(255, 107, 107, 0.3);
  border-radius: 6px;
  margin-bottom: 8px;
  font-size: 12px;
}

.anti-synergy-warning-icon {
  font-size: 16px;
  color: #ff6b6b;
}

.anti-synergy-warning-text {
  flex: 1;
  color: #ff6b6b;
}

/* Recommendations */
.recommendation-item {
  padding: 12px;
  background: rgba(38, 222, 129, 0.1);
  border: 1px solid rgba(38, 222, 129, 0.3);
  border-radius: 6px;
  margin-bottom: 8px;
}

.recommendation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.recommendation-title {
  color: #26de81;
  font-weight: 500;
  font-size: 13px;
}

.recommendation-gain {
  color: #26de81;
  font-size: 11px;
  font-weight: bold;
}

.recommendation-description {
  color: #ccc;
  font-size: 12px;
  line-height: 1.4;
}

/* Why Inspector */
.why-inspector.open {
  right: 0;
}

.why-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: rgba(255, 255, 255, 0.05);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.why-header h3 {
  margin: 0;
  color: #fff;
  font-size: 16px;
}

#closeWhyInspector {
  background: none;
  border: none;
  color: #aaa;
  font-size: 20px;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
}

#closeWhyInspector:hover {
  color: #fff;
}

.why-content {
  padding: 16px;
}

.causal-step {
  margin-bottom: 12px;
  padding: 8px;
  background: rgba(255, 255, 255, 0.02);
  border-radius: 4px;
  border-left: 3px solid #4a9eff;
}

.causal-step-header {
  font-weight: 500;
  color: #4a9eff;
  font-size: 12px;
  margin-bottom: 4px;
}

.causal-step-details {
  color: #ccc;
  font-size: 11px;
  line-height: 1.4;
}

/* Sparklines */
.sparkline {
  display: inline-block;
  width: 40px;
  height: 16px;
  margin-left: 6px;
  vertical-align: middle;
}

.sparkline-bar {
  display: inline-block;
  width: 2px;
  background: #4a9eff;
  margin-right: 1px;
  border-radius: 1px;
}

.emptySlot {
  color: #666;
  font-style: italic;
  text-align: center;
  padding: 20px;
}

/* Simulation enhancements */

@keyframes battle-glow {
  0%, 100% { box-shadow: 0 0 40px rgba(0,255,51,0.2); }
  50% { box-shadow: 0 0 60px rgba(0,255,51,0.4); }
}

.battle-button {
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.battle-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,255,51,0.4);
}

.battle-button:active {
  transform: translateY(0);
}

.battle-log-line {
  border-left: 3px solid transparent;
  padding-left: 8px;
  margin: 4px 0;
  transition: all 0.2s ease;
}

.battle-log-line.player {
  border-left-color: #0f3;
}

.battle-log-line.opponent {
  border-left-color: #f33;
}

.battle-log-line.system {
  border-left-color: #fa0;
}

.battle-log-line:hover {
  background: rgba(0,255,51,0.1);
  border-radius: 4px;
}

.sim-preview-item {
  display: inline-block;
  width: 24px;
  height: 24px;
  border: 1px solid #333;
  border-radius: 4px;
  margin: 2px;
  background: #111;
  image-rendering: pixelated;
}

.result-victory {
  color: #0f3;
  text-shadow: 0 0 10px rgba(0,255,51,0.5);
  font-weight: 900;
}

.result-defeat {
  color: #f33;
  text-shadow: 0 0 10px rgba(255,51,51,0.5);
  font-weight: 900;
}

/* Battle Replay System Styles */
.replay-btn {
  transition: all 0.2s ease;
  font-size: 14px;
  min-width: 40px;
}

.replay-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,255,51,0.3);
}

.replay-btn:active {
  transform: scale(0.95);
}

.replay-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* Three-Pane Layout Specific Styles */
.fighter-card {
  transition: all 0.3s ease;
}

.fighter-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,255,51,0.2);
}

.fighter-card.opponent-card:hover {
  box-shadow: 0 4px 12px rgba(255,51,51,0.2);
}

.stat-chip {
  transition: all 0.2s ease;
}

.stat-chip:hover {
  transform: scale(1.05);
}

.status-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: rgba(255,255,255,0.1);
  border: 1px solid #666;
  border-radius: 12px;
  padding: 2px 6px;
  font-size: 10px;
  color: #ccc;
  transition: all 0.2s ease;
}

.status-chip:hover {
  background: rgba(255,255,255,0.2);
  transform: scale(1.1);
}

.status-chip.poison { border-color: #8a2be2; color: #8a2be2; }
.status-chip.thorns { border-color: #8b4513; color: #8b4513; }
.status-chip.regen { border-color: #32cd32; color: #32cd32; }
.status-chip.stun { border-color: #ffd700; color: #ffd700; }
.status-chip.acid { border-color: #adff2f; color: #adff2f; }
.status-chip.freeze { border-color: #87ceeb; color: #87ceeb; }
.status-chip.riptide { border-color: #4169e1; color: #4169e1; }
.status-chip.purity { border-color: #f0f8ff; color: #f0f8ff; }

/* Enhanced status chip micro-patterns */
.status-chip-icon {
  font-size: 10px;
}

.status-chip-value {
  font-weight: bold;
  color: inherit;
}

.status-chip-trend {
  font-size: 8px;
  opacity: 0.8;
  margin-left: 2px;
}

.status-chip-trend.positive { color: #0f3; }
.status-chip-trend.negative { color: #f33; }

/* Enhanced phase headers */
.log-phase-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: linear-gradient(135deg, #2a3441 0%, #1e2832 100%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  cursor: pointer;
  font-weight: 600;
}

.phase-title {
  font-size: 13px;
  color: #fff;
}

.phase-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 11px;
  color: #aaa;
}

.trigger-count {
  background: rgba(255, 255, 255, 0.1);
  padding: 1px 6px;
  border-radius: 8px;
  font-weight: 500;
}

/* Effect rows with enhanced styling */
.effect-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
  font-size: 12px;
}

.effect-source {
  color: #4a9eff;
  font-weight: 500;
  min-width: 80px;
}

.effect-arrow {
  color: #666;
  font-weight: normal;
}

.effect-target {
  color: #ff6b6b;
  font-weight: 500;
}

.effect-description {
  color: #ccc;
  flex: 1;
}

/* Synergy tags */
.synergy-tag {
  display: inline-block;
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 600;
  margin: 1px 2px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.synergy-tag.symphony { 
  background: linear-gradient(135deg, #9c88ff 0%, #7c4dff 100%);
}

.synergy-tag.bomb { 
  background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);
}

.synergy-tag.fruit { 
  background: linear-gradient(135deg, #26de81 0%, #20bf6b 100%);
}

/* Summary strip */
.summary-strip {
  display: flex;
  gap: 12px;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 6px;
  font-size: 11px;
  font-weight: 500;
  margin: 4px 0;
}

.summary-stat {
  display: flex;
  align-items: center;
  gap: 4px;
  color: #ccc;
}

.summary-stat-value {
  color: #fff;
  font-weight: bold;
}

.summary-stat.damage .summary-stat-value { color: #ff6b6b; }
.summary-stat.healing .summary-stat-value { color: #26de81; }
.summary-stat.strikes .summary-stat-value { color: #4a9eff; }
.summary-stat.cooldown .summary-stat-value { color: #ffa726; }

.delta-indicator {
  font-size: 10px;
  font-weight: 700;
  margin-left: 4px;
  animation: deltaFlash 0.6s ease-in-out;
}

.delta-indicator.positive { color: #0f3; }
.delta-indicator.negative { color: #f33; }

@keyframes deltaFlash {
  0% { opacity: 0; transform: scale(1.5); }
  50% { opacity: 1; transform: scale(1.2); }
  100% { opacity: 1; transform: scale(1); }
}

/* Loadout tray styles */
.loadout-item {
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.05);
  border: 1px solid #333;
  border-radius: 6px;
  padding: 6px 8px;
  font-size: 11px;
  transition: all 0.2s ease;
}

.loadout-item:hover {
  background: rgba(255,255,255,0.1);
  border-color: #666;
}

.loadout-item img {
  width: 20px;
  height: 20px;
  image-rendering: pixelated;
}

.loadout-item.weapon {
  border-color: #ff9900;
  color: #ff9900;
}

.loadout-item.tier-gold {
  box-shadow: 0 0 4px rgba(255,215,0,0.3);
}

.loadout-item.tier-diamond {
  box-shadow: 0 0 4px rgba(185,242,255,0.3);
}

/* Phase-based log styling */
.log-phase-card {
  margin: 12px 0;
  background: rgba(255,255,255,0.02);
  border: 1px solid #333;
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.2s ease;
}

.log-phase-card.expanded {
  border-color: #666;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.log-phase-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: rgba(255,255,255,0.05);
  cursor: pointer;
  transition: all 0.2s ease;
}

.log-phase-header:hover {
  background: rgba(255,255,255,0.08);
}

.log-phase-header.battle-start { border-left: 4px solid #0f3; }
.log-phase-header.turn-start { border-left: 4px solid #fa0; }
.log-phase-header.strike { border-left: 4px solid #f33; }
.log-phase-header.wounded { border-left: 4px solid #f0a; }
.log-phase-header.exposed { border-left: 4px solid #af5; }
.log-phase-header.countdown { border-left: 4px solid #5af; }

.log-phase-summary {
  font-size: 11px;
  color: #888;
  font-style: italic;
}

.log-phase-content {
  padding: 12px;
  border-top: 1px solid #333;
  display: none;
  font-size: 12px;
  line-height: 1.5;
}

.log-phase-content.expanded {
  display: block;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Enhanced battle log with replay features */
.battle-log-line {
  border-left: 3px solid transparent;
  padding-left: 8px;
  margin: 4px 0;
  transition: all 0.2s ease;
  line-height: 1.8;
  cursor: pointer;
  position: relative;
}

.battle-log-line.active {
  background: rgba(0,255,51,0.15);
  border-radius: 4px;
  border-left-color: #0f3;
  box-shadow: 0 0 15px rgba(0,255,51,0.2);
  transform: translateX(4px);
}

.battle-log-line.current-turn {
  background: rgba(255,215,0,0.1);
  border-left-color: #ffd700;
  animation: pulse-gold 2s ease-in-out infinite;
}

@keyframes pulse-gold {
  0%, 100% { box-shadow: 0 0 5px rgba(255,215,0,0.3); }
  50% { box-shadow: 0 0 20px rgba(255,215,0,0.6); }
}

.battle-log-line .log-icon {
  width: 16px;
  height: 16px;
  margin-right: 6px;
  vertical-align: middle;
  image-rendering: pixelated;
  opacity: 0.9;
}

.battle-log-line .turn-marker {
  position: absolute;
  left: -20px;
  top: 50%;
  transform: translateY(-50%);
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #0a5;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.battle-log-line.active .turn-marker {
  opacity: 1;
}

/* HP tracking in log lines */
.hp-tracker {
  font-size: 12px;
  color: #888;
  margin-left: 8px;
  font-weight: normal;
}

.hp-tracker.player {
  color: #0a8;
}

.hp-tracker.opponent {
  color: #a55;
}

.result-draw {
  color: #fa0;
  text-shadow: 0 0 10px rgba(255,170,0,0.5);
  font-weight: 900;
}
</style>
</head>
<body>
<header><h1>He Is Coming   " Loadout Builder (v5)</h1></header>
<div class="frame">
  <!-- LEFT / PLAYER -->
  <section class="panel" id="panelP">
    <div class="title">Oils</div>
    <div class="oils" id="oilsP">
      <div class="oil" data-kind="attack"><img src="assets/attack.png"><span>Attack Oil</span></div>
      <div class="oil" data-kind="armor"><img src="assets/armor.png"><span>Armor Oil</span></div>
      <div class="oil" data-kind="speed"><img src="assets/speed.png"><span>Speed Oil</span></div>
    </div>
    <div class="weapon-slot" id="weaponP">Drop a Weapon</div>
    <div class="edge-tile">
      <div class="edge-body">
        <img id="edgePIcon" src="assets/placeholder.png" alt="">
        <select id="edgeP"><option value="">  " Select Edge   "</option></select>
      </div>
      <div id="edgePEffect" class="meta effect"></div>
    </div>
    <div class="selIndicator" id="selPI">Selected: None</div>
    <div class="grid12" id="gridP"></div>
    <div class="stats">
      <div class="stat"><img src="assets/health.png" alt="health"><span id="pH">10</span></div>
      <div class="stat"><img src="assets/attack.png" alt="atk"><span id="pA">0</span></div>
      <div class="stat"><img src="assets/armor.png" alt="arm"><span id="pR">0</span></div>
      <div class="stat"><img src="assets/speed.png" alt="spd"><span id="pS">0</span></div>
    </div>
    <div class="setsBox" id="setsP"></div>
  </section>

  <!-- CENTER COLUMN -->
  <div style="grid-column: 2; display: flex; flex-direction: column; height: 100%; min-height:0;">
    <div class="tabs" style="display:flex; gap:2px; margin-bottom:8px;">
      <button id="tabCompendium" class="tabBtn" style="background:#111;color:#f33;border:2px solid #f33;border-radius:8px 8px 0 0;padding:8px 24px;cursor:pointer;font-size:16px;">Compendium</button>
      <button id="tabAnalysis" class="tabBtn" style="background:#111;color:#fa0;border:2px solid #fa0;border-radius:8px 8px 0 0;padding:8px 24px;cursor:pointer;font-size:16px;">Analysis</button>
      <button id="tabSimulation" class="tabBtn" style="background:#111;color:#0f3;border:2px solid #0f3;border-radius:8px 8px 0 0;padding:8px 24px;cursor:pointer;font-size:16px;">Simulation</button>
    </div>
    <section class="center" id="compendiumTab" style="flex:1; display:flex; flex-direction:column; min-height:0;">
      <!-- Advanced Compendium Header -->
      <div class="compendium-header" style="
        background: linear-gradient(135deg, #1a1f2e 0%, #16202d 100%); 
        padding: 16px 20px; 
        border-bottom: 2px solid #f33;
        flex-shrink: 0;
      ">
        <!-- Top Row: Search + View Controls -->
        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px; flex-wrap: wrap;">
          
          <!-- Global Search with Chips -->
          <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 300px;">
            <input id="globalSearch" type="search" placeholder="Search items, effects, tags..." style="
              flex: 1; 
              background: #000; 
              color: #f33; 
              border: 2px solid #f33; 
              border-radius: 8px; 
              padding: 8px 12px; 
              font-size: 14px;
            ">
            <div id="searchChips" style="display: flex; gap: 4px; flex-wrap: wrap;"></div>
          </div>
          
          <!-- View Switch -->
          <div class="view-switch" style="display: flex; gap: 2px; background: #000; border: 2px solid #f33; border-radius: 8px; overflow: hidden;">
            <button id="viewCards" class="view-btn active" style="padding: 8px 16px; background: #f33; color: #000; border: none; cursor: pointer; font-size: 12px; font-weight: 600;">Cards</button>
            <button id="viewTable" class="view-btn" style="padding: 8px 16px; background: transparent; color: #f33; border: none; cursor: pointer; font-size: 12px; font-weight: 600;">Table</button>
            <button id="viewCompare" class="view-btn" style="padding: 8px 16px; background: transparent; color: #f33; border: none; cursor: pointer; font-size: 12px; font-weight: 600;">Compare</button>
          </div>
          
          <!-- Needs Review Toggle -->
          <label style="display: flex; align-items: center; gap: 6px; color: #fa0; font-size: 12px; font-weight: 600;">
            <input type="checkbox" id="needsReviewToggle" style="accent-color: #fa0;">
            <span>  Needs Review</span>
            <span id="reviewCount" style="background: #fa0; color: #000; border-radius: 10px; padding: 1px 6px; font-size: 10px;">0</span>
          </label>
          
          <!-- Tier Switcher -->
          <div class="tier-switcher" style="display: flex; gap: 2px; background: #000; border: 2px solid #ffd166; border-radius: 8px; overflow: hidden;">
            <button id="tierBase" class="tier-btn active" style="padding: 6px 12px; background: #ffd166; color: #000; border: none; cursor: pointer; font-size: 11px; font-weight: 600;">Base</button>
            <button id="tierGold" class="tier-btn" style="padding: 6px 12px; background: transparent; color: #ffd166; border: none; cursor: pointer; font-size: 11px; font-weight: 600;">Gold</button>
            <button id="tierDiamond" class="tier-btn" style="padding: 6px 12px; background: transparent; color: #ffd166; border: none; cursor: pointer; font-size: 11px; font-weight: 600;">Diamond</button>
          </div>
          
        </div>
        
        <!-- Bottom Row: Quick Actions + Stats -->
        <div style="display: flex; gap: 12px; align-items: center; justify-content: space-between;">
          
          <!-- Quick Actions -->
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button id="randBuildBtn" type="button" title="Fill your slots with random items, a random weapon, and a random edge" style="background:#f33;color:#000;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px;font-weight:600;">   Random Build</button>
            <button id="randEnemyBtn" type="button" title="Randomize the opponent's loadout" style="background:#f33;color:#000;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px;font-weight:600;">   Random Enemy</button>
            <button id="showSimBtn" type="button" style="background:#0f3;color:#000;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px;font-weight:600;">   Battle</button>
            
            <!-- QA & Authoring Tools -->
            <div style="border-left: 1px solid #666; padding-left: 8px; margin-left: 8px; display: flex; gap: 6px;">
              <button id="bulkSelectAll" title="Select all visible items" style="background: transparent; color: #0f3; border: 1px solid #0f3; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">All</button>
              <button id="bulkSelectNone" title="Clear all selections" style="background: transparent; color: #f30; border: 1px solid #f30; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">None</button>
              <button id="exportSelected" title="Export selected items as JSON" style="background: transparent; color: #fa0; border: 1px solid #fa0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Export</button>
              <button id="qaValidate" title="Run quality assurance checks" style="background: transparent; color: #af5; border: 1px solid #af5; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">QA</button>
            </div>
          </div>
          
          <!-- Summary Stats -->
          <div style="display: flex; gap: 16px; align-items: center; font-size: 12px;">
            <div id="dataHealthIndicator" style="display: flex; align-items: center; gap: 4px;">
              <span style="width: 8px; height: 8px; border-radius: 50%; background: #666;" id="healthDot"></span>
              <span style="color: #666; font-size: 10px;" id="healthText">Loading...</span>
            </div>
            <span style="color: #aaa;">Showing:</span>
            <span id="shownCount" style="color: #fff; font-weight: 600;">0</span>
            <span style="color: #666;">/</span>
            <span id="totalCount" style="color: #aaa;">0</span>
            <div style="width: 1px; height: 16px; background: #666;"></div>
            <span style="color: #aaa;">Selected:</span>
            <span id="selectedCount" style="color: #fa0; font-weight: 600;">0</span>
          </div>
          
        </div>
      </div>
      
      <!-- Main Content Layout -->
      <div class="compendium-main" style="flex: 1; display: flex; min-height: 0; overflow: hidden;">
        
        <!-- Left Facet Panel -->
        <div class="facet-panel" style="
          width: 280px; 
          background: #0a0a0a; 
          border-right: 2px solid #333; 
          overflow-y: auto; 
          padding: 16px; 
          flex-shrink: 0;
        ">
          
          <!-- Bucket Filter -->
          <div class="facet-group" style="margin-bottom: 20px;">
            <h4 style="color: #f33; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Bucket</h4>
            <div class="bucket-filters" style="display: flex; flex-direction: column; gap: 4px;">
              <label class="facet-option active" style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; background: rgba(255,51,51,0.1); border-left: 3px solid #f33;">
                <input type="checkbox" name="bucket" value="all" checked style="accent-color: #f33;">
                <span style="color: #f33; font-weight: 600;">All Items</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" name="bucket" value="items" style="accent-color: #f33;">
                <span>Items</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" name="bucket" value="weapons" style="accent-color: #f33;">
                <span>Weapons</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" name="bucket" value="upgrades" style="accent-color: #f33;">
                <span>Upgrades</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
            </div>
          </div>
          
          <!-- Tag Families -->
          <div class="facet-group" style="margin-bottom: 20px;">
            <h4 style="color: #f33; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Tag Families</h4>
            <div class="tag-families" style="display: flex; flex-direction: column; gap: 2px;">
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Tome" style="accent-color: #73d2de;">
                <span>   Tome</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Bomb" style="accent-color: #ff9500;">
                <span>   Bomb</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Symphony" style="accent-color: #9c88ff;">
                <span>   Symphony</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Food" style="accent-color: #95d5b2;">
                <span>   Food</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Jewelry" style="accent-color: #ffd166;">
                <span>   Jewelry</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Ring" style="accent-color: #ffd166;">
                <span>   Ring</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Stone" style="accent-color: #8b4513;">
                <span>   Stone</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Water" style="accent-color: #4169e1;">
                <span>   Water</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Wood" style="accent-color: #8b5a2b;">
                <span>   Wood</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Rune" style="accent-color: #00ced1;">
                <span>   Rune</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Potion" style="accent-color: #66ccff;">
                <span>   Potion</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Crone" style="accent-color: #c71585;">
                <span>   Crone</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Rose" style="accent-color: #ff6699;">
                <span>   Rose</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Mythic" style="accent-color: #bb86fc;">
                <span>   Mythic</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Sanguine" style="accent-color: #dc143c;">
                <span>   Sanguine</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Unique" style="accent-color: #ffaa00;">
                <span>   Unique</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Forge Upgrades" style="accent-color: #f4a261;">
                <span>   Edge</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
            </div>
          </div>
          
          <!-- Trigger Filters -->
          <div class="facet-group" style="margin-bottom: 20px;">
            <h4 style="color: #f33; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Triggers</h4>
            <div class="trigger-filters" style="display: flex; flex-direction: column; gap: 2px;">
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="trigger" value="battleStart" style="accent-color: #0f3;">
                <span>   Battle Start</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="trigger" value="turnStart" style="accent-color: #fa0;">
                <span>  Turn Start</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="trigger" value="hit" style="accent-color: #f33;">
                <span>   On Hit</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="trigger" value="wounded" style="accent-color: #f0a;">
                <span>   On Wounded</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="trigger" value="exposed" style="accent-color: #af5;">
                <span>    On Exposed</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="trigger" value="passive" style="accent-color: #888;">
                <span>  Passive</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
            </div>
          </div>
          
          <!-- Clear Filters -->
          <button id="clearAllFilters" style="
            width: 100%; 
            background: transparent; 
            color: #666; 
            border: 1px solid #666; 
            border-radius: 4px; 
            padding: 8px; 
            cursor: pointer; 
            font-size: 11px; 
            margin-top: 16px;
          ">Clear All Filters</button>
          
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
          
          <!-- Cards View (Default) -->
          <div id="cardsView" class="content-view" style="flex: 1; overflow-y: auto; padding: 16px;">
            <div id="itemGrid" class="grid" style="
              display: grid; 
              grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
              gap: 12px; 
              justify-items: stretch; 
              align-content: start;
            "></div>
          </div>
          
          <!-- Table View (Hidden by default) -->
          <div id="tableView" class="content-view" style="display: none; flex: 1; overflow: auto; padding: 16px;">
            <table id="itemTable" style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead>
                <tr style="background: rgba(255,255,255,0.05); position: sticky; top: 0;">
                  <th style="text-align: left; padding: 8px; border-bottom: 1px solid #333; color: #f33;">Name</th>
                  <th style="text-align: left; padding: 8px; border-bottom: 1px solid #333; color: #f33;">Bucket</th>
                  <th style="text-align: left; padding: 8px; border-bottom: 1px solid #333; color: #f33;">Tags</th>
                  <th style="text-align: center; padding: 8px; border-bottom: 1px solid #333; color: #f33;">Triggers</th>
                  <th style="text-align: center; padding: 8px; border-bottom: 1px solid #333; color: #f33;">ATK</th>
                  <th style="text-align: center; padding: 8px; border-bottom: 1px solid #333; color: #f33;">ARM</th>
                  <th style="text-align: center; padding: 8px; border-bottom: 1px solid #333; color: #f33;">HP</th>
                  <th style="text-align: center; padding: 8px; border-bottom: 1px solid #333; color: #f33;">SPD</th>
                  <th style="text-align: left; padding: 8px; border-bottom: 1px solid #333; color: #f33;">Effect</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
          
          <!-- Compare View (Hidden by default) -->
          <div id="compareView" class="content-view" style="display: none; flex: 1; overflow: auto; padding: 16px;">
            <div class="compare-header" style="text-align: center; margin-bottom: 20px;">
              <h3 style="color: #f33; margin: 0;">Compare Items</h3>
              <p style="color: #aaa; font-size: 12px; margin: 8px 0;">Select 2-3 items from the Cards view to compare side-by-side</p>
            </div>
            <div id="compareContent" style="display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
              <div style="color: #666; font-style: italic; grid-column: 1/-1; text-align: center; padding: 40px;">No items selected for comparison</div>
            </div>
          </div>
          
        </div>
        
      </div>
    </section>
    <section class="center" id="analysisTab" style="flex:1; display:none; flex-direction:column; min-height:0;">
      <!-- Battle Analysis Header -->
      <div class="analysis-header" style="background: linear-gradient(135deg, #1a1f2e 0%, #16202d 100%); padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <h2 style="color: #fff; font-size: 24px; margin: 0; text-align: center;">Battle Analysis</h2>
        <p style="color: #aaa; font-size: 14px; margin: 8px 0 0 0; text-align: center;">Turn raw logs into insight: KPIs, breakdowns, and clear recommendations</p>
      </div>
      
      <!-- Outcome KPIs Sticky Strip -->
      <div id="outcomeKPIs" class="outcome-kpis" style="
        background: rgba(0,0,0,0.8); 
        padding: 12px 16px; 
        border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
        justify-content: center;
        position: sticky;
        top: 0;
        z-index: 10;
      ">
        <div class="kpi-item">
          <div class="kpi-label">TTK</div>
          <div class="kpi-value" id="kpiTTK">-</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-label">Survived</div>
          <div class="kpi-value" id="kpiSurvived">-</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-label">Damage Dealt</div>
          <div class="kpi-value" id="kpiDamageDealt">-</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-label">Damage Taken</div>
          <div class="kpi-value" id="kpiDamageTaken">-</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-label">Strike Uptime</div>
          <div class="kpi-value" id="kpiStrikeUptime">-</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-label">Net Tempo</div>
          <div class="kpi-value" id="kpiNetTempo">-</div>
        </div>
      </div>
      
      <!-- Main Analysis Content -->
      <div class="analysis-content" style="
        flex: 1; 
        overflow: auto; 
        padding: 16px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      ">
        
        <!-- Left Column -->
        <div class="analysis-left">
          
          <!-- Damage Sources Panel -->
          <div class="analysis-panel" id="damageSources">
            <div class="analysis-panel-header">
              <h3>Damage Sources</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div class="damage-chart" id="damageChart"></div>
              <div class="damage-list" id="damageList"></div>
            </div>
          </div>
          
          <!-- Status Impact Panel -->
          <div class="analysis-panel" id="statusImpact">
            <div class="analysis-panel-header">
              <h3>Status Impact</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div id="statusBreakdown"></div>
            </div>
          </div>
          
          <!-- Armor Economy Panel -->
          <div class="analysis-panel" id="armorEconomy">
            <div class="analysis-panel-header">
              <h3>Armor Economy</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div id="armorFlow"></div>
            </div>
          </div>
          
        </div>
        
        <!-- Right Column -->
        <div class="analysis-right">
          
          <!-- Trigger Heatmap Panel -->
          <div class="analysis-panel" id="triggerHeatmap">
            <div class="analysis-panel-header">
              <h3>Trigger Heatmap</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div id="heatmapMatrix"></div>
            </div>
          </div>
          
          <!-- Synergy Detection Panel -->
          <div class="analysis-panel" id="synergyDetection">
            <div class="analysis-panel-header">
              <h3>Synergy Analysis</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div id="synergyCallouts"></div>
              <div id="antiSynergyWarnings"></div>
            </div>
          </div>
          
          <!-- Bottlenecks & Risks Panel -->
          <div class="analysis-panel" id="bottlenecks">
            <div class="analysis-panel-header">
              <h3>Bottlenecks & Risks</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div id="limitingFactors"></div>
              <div id="riskAlerts"></div>
            </div>
          </div>
          
          <!-- Recommendations Panel -->
          <div class="analysis-panel" id="recommendations">
            <div class="analysis-panel-header">
              <h3>Recommendations</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div id="recommendationList"></div>
            </div>
          </div>
          
        </div>
        
      </div>
      
      <!-- Why Inspector Side Panel -->
      <div id="whyInspector" class="why-inspector" style="
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: #1a1f2e;
        border-left: 1px solid rgba(255,255,255,0.2);
        z-index: 1000;
        transition: right 0.3s ease;
        overflow-y: auto;
      ">
        <div class="why-header">
          <h3>Why Inspector</h3>
          <button id="closeWhyInspector"> </button>
        </div>
        <div class="why-content">
          <div id="causalChain"></div>
          <div id="neighbors"></div>
          <div id="firstTurnView"></div>
        </div>
      </div>
      
    </section>
    <section class="center" id="simulationTab" style="flex:1; display:none; flex-direction:column; min-height:0; background: #000;">
      <!-- Three-Pane Layout: Fighter Cards | Event Log | Loadout Tray -->
      <div class="sim-three-pane" style="display: grid; grid-template-columns: 320px 1fr 320px; gap: 12px; height: 100%; min-height: 0; padding: 12px;">
        
        <!-- LEFT PANE: Sticky Summary (Fighter Cards) -->
        <div class="fighter-summary-pane" style="display: flex; flex-direction: column; gap: 16px; background: #0a0a0a; border: 2px solid #333; border-radius: 12px; padding: 16px; overflow-y: auto; position: sticky; top: 0; height: fit-content; max-height: 100vh;">
          
          <!-- Pinned Key Numbers -->
          <div id="pinnedMetrics" style="background: rgba(0,50,20,0.8); border: 2px solid #0a5; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
            <div style="color: #0a5; font-size: 12px; font-weight: 600; text-align: center; margin-bottom: 8px;">LIVE METRICS</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
              <div style="text-align: center;">
                <div style="color: #888;">Damage Dealt</div>
                <div id="totalDamageDealt" style="color: #f33; font-weight: 700;">0</div>
              </div>
              <div style="text-align: center;">
                <div style="color: #888;">Damage Taken</div>
                <div id="totalDamageTaken" style="color: #f33; font-weight: 700;">0</div>
              </div>
              <div style="text-align: center;">
                <div style="color: #888;">Strikes Queued</div>
                <div id="strikesQueued" style="color: #fa0; font-weight: 700;">0</div>
              </div>
              <div style="text-align: center;">
                <div style="color: #888;">Lethal ETA</div>
                <div id="lethalETA" style="color: #f0a; font-weight: 700;"> </div>
              </div>
            </div>
          </div>

          <!-- Player Fighter Card -->
          <div class="fighter-card player-card" style="background: rgba(0,255,51,0.1); border: 2px solid #0f3; border-radius: 12px; padding: 14px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <h3 style="color: #0f3; margin: 0; font-size: 16px; text-shadow: 0 0 8px rgba(0,255,51,0.5);">PLAYER</h3>
              <div id="playerResult" style="font-size: 12px; font-weight: 600; display: none;"></div>
            </div>
            
            <!-- Core Stats -->
            <div class="core-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
              <div class="stat-chip" style="display: flex; align-items: center; gap: 6px; background: #1a1a1a; border: 1px solid #0f3; border-radius: 6px; padding: 6px 8px;">
                <img src="assets/health.png" style="width: 16px; height: 16px; image-rendering: pixelated;">
                <span style="color: #0f3; font-size: 14px; font-weight: 600;"><span id="playerHP">10</span>/<span id="playerMaxHP">10</span></span>
              </div>
              <div class="stat-chip" style="display: flex; align-items: center; gap: 6px; background: #1a1a1a; border: 1px solid #0f3; border-radius: 6px; padding: 6px 8px;">
                <img src="assets/armor.png" style="width: 16px; height: 16px; image-rendering: pixelated;">
                <span style="color: #0f3; font-size: 14px; font-weight: 600;" id="playerArmor">0</span>
              </div>
              <div class="stat-chip" style="display: flex; align-items: center; gap: 6px; background: #1a1a1a; border: 1px solid #0f3; border-radius: 6px; padding: 6px 8px;">
                <img src="assets/attack.png" style="width: 16px; height: 16px; image-rendering: pixelated;">
                <span style="color: #0f3; font-size: 14px; font-weight: 600;" id="playerAttack">0</span>
              </div>
              <div class="stat-chip" style="display: flex; align-items: center; gap: 6px; background: #1a1a1a; border: 1px solid #0f3; border-radius: 6px; padding: 6px 8px;">
                <img src="assets/speed.png" style="width: 16px; height: 16px; image-rendering: pixelated;">
                <span style="color: #0f3; font-size: 14px; font-weight: 600;" id="playerSpeed">0</span>
              </div>
            </div>

            <!-- Status Effects -->
            <div id="playerStatusEffects" class="status-effects" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 28px;">
              <div style="color: #666; font-size: 11px; font-style: italic;">No status effects</div>
            </div>
          </div>

          <!-- Opponent Fighter Card -->
          <div class="fighter-card opponent-card" style="background: rgba(255,51,51,0.1); border: 2px solid #f33; border-radius: 12px; padding: 14px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <h3 style="color: #f33; margin: 0; font-size: 16px; text-shadow: 0 0 8px rgba(255,51,51,0.5);">OPPONENT</h3>
              <div id="opponentResult" style="font-size: 12px; font-weight: 600; display: none;"></div>
            </div>
            
            <!-- Core Stats -->
            <div class="core-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
              <div class="stat-chip" style="display: flex; align-items: center; gap: 6px; background: #1a1a1a; border: 1px solid #f33; border-radius: 6px; padding: 6px 8px;">
                <img src="assets/health.png" style="width: 16px; height: 16px; image-rendering: pixelated;">
                <span style="color: #f33; font-size: 14px; font-weight: 600;"><span id="opponentHP">10</span>/<span id="opponentMaxHP">10</span></span>
              </div>
              <div class="stat-chip" style="display: flex; align-items: center; gap: 6px; background: #1a1a1a; border: 1px solid #f33; border-radius: 6px; padding: 6px 8px;">
                <img src="assets/armor.png" style="width: 16px; height: 16px; image-rendering: pixelated;">
                <span style="color: #f33; font-size: 14px; font-weight: 600;" id="opponentArmor">0</span>
              </div>
              <div class="stat-chip" style="display: flex; align-items: center; gap: 6px; background: #1a1a1a; border: 1px solid #f33; border-radius: 6px; padding: 6px 8px;">
                <img src="assets/attack.png" style="width: 16px; height: 16px; image-rendering: pixelated;">
                <span style="color: #f33; font-size: 14px; font-weight: 600;" id="opponentAttack">0</span>
              </div>
              <div class="stat-chip" style="display: flex; align-items: center; gap: 6px; background: #1a1a1a; border: 1px solid #f33; border-radius: 6px; padding: 6px 8px;">
                <img src="assets/speed.png" style="width: 16px; height: 16px; image-rendering: pixelated;">
                <span style="color: #f33; font-size: 14px; font-weight: 600;" id="opponentSpeed">0</span>
              </div>
            </div>

            <!-- Status Effects -->
            <div id="opponentStatusEffects" class="status-effects" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 28px;">
              <div style="color: #666; font-size: 11px; font-style: italic;">No status effects</div>
            </div>
          </div>

          <!-- Battle Controls -->
          <div style="display: flex; flex-direction: column; gap: 8px; margin-top: auto;">
            <button id="btnSimulate" type="button" title="Run a simulation between the two loadouts" class="battle-button" style="background: linear-gradient(135deg, #0f3 0%, #0a8 100%); color: #000; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-size: 14px; font-weight: 700; box-shadow: 0 2px 8px rgba(0,255,51,0.3);">   START BATTLE</button>
            <button id="btnClearLog" type="button" title="Clear the simulation log" style="background: #333; color: #fff; border: none; border-radius: 8px; padding: 8px; cursor: pointer; font-size: 12px;">   Clear Log</button>
          </div>
        </div>

        <!-- MIDDLE PANE: Event Log -->
        <div class="event-log-pane" style="display: flex; flex-direction: column; background: #0a0a0a; border: 2px solid #333; border-radius: 12px; overflow: hidden; min-height: 0;">
          
          <!-- Log Header -->
          <div style="background: linear-gradient(90deg, #333 0%, #555 100%); padding: 12px 16px; border-bottom: 2px solid #333; flex-shrink: 0;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <h3 style="color: #fff; font-size: 16px; font-weight: 700; margin: 0;">   EVENT LOG</h3>
              <div style="display: flex; align-items: center; gap: 12px;">
                <!-- Noise Filter Toggle -->
                <label style="display: flex; align-items: center; gap: 6px; color: #ccc; font-size: 12px;">
                  <input type="checkbox" id="noiseFilterToggle" style="accent-color: #0f3;">
                  Hide noise
                </label>
                <div id="battleStatus" style="color: #ccc; font-size: 12px; font-weight: 600;">Ready</div>
              </div>
            </div>
          </div>
          
          <!-- Timeline Controls -->
          <div id="timelineControls" style="display: none; background: rgba(0,20,0,0.8); border-bottom: 2px solid #0a5; padding: 12px 16px; flex-shrink: 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 6px;">
                <button id="replayFirst" class="replay-btn" style="background: #0a5; color: #000; border: none; border-radius: 4px; padding: 6px 8px; cursor: pointer; font-size: 11px; font-weight: 700;">  </button>
                <button id="replayBack" class="replay-btn" style="background: #0a5; color: #000; border: none; border-radius: 4px; padding: 6px 8px; cursor: pointer; font-size: 11px; font-weight: 700;">&lt;&lt;</button>
                <button id="replayPlay" class="replay-btn" style="background: #0f3; color: #000; border: none; border-radius: 4px; padding: 6px 8px; cursor: pointer; font-size: 11px; font-weight: 700;">  </button>
                <button id="replayForward" class="replay-btn" style="background: #0a5; color: #000; border: none; border-radius: 4px; padding: 6px 8px; cursor: pointer; font-size: 11px; font-weight: 700;">&gt;&gt;</button>
                <button id="replayLast" class="replay-btn" style="background: #0a5; color: #000; border: none; border-radius: 4px; padding: 6px 8px; cursor: pointer; font-size: 11px; font-weight: 700;">  </button>
              </div>
              <div style="display: flex; align-items: center; gap: 6px; color: #0f3; font-size: 11px;">
                <label>Turn:</label>
                <input id="turnInput" type="number" min="1" value="1" style="width: 50px; background: #000; color: #0f3; border: 1px solid #0a5; border-radius: 4px; padding: 4px 6px; font-size: 11px; text-align: center;">
                <span id="turnTotal">/ 0</span>
              </div>
              <div style="display: flex; align-items: center; gap: 6px; color: #0f3; font-size: 11px;">
                <label>Speed:</label>
                <select id="replaySpeed" style="background: #000; color: #0f3; border: 1px solid #0a5; border-radius: 4px; padding: 2px 4px; font-size: 11px;">
                  <option value="2000">0.5 </option>
                  <option value="1000" selected>1 </option>
                  <option value="500">2 </option>
                  <option value="250">4 </option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Battle Log Content -->
          <div id="simLog" style="flex: 1; overflow-y: auto; padding: 16px; font-size: 14px; color: #ccc; line-height: 1.6; min-height: 0;" aria-live="polite">
            <div style="text-align: center; color: #666; font-style: italic; padding: 40px 20px;">
              <img src="assets/attack.png" style="width: 16px; height: 16px; vertical-align: middle; image-rendering: pixelated;"> Ready to witness epic battles!<br><br>
              Configure your loadouts and hit <strong style="color: #0f3;">"START BATTLE"</strong> to begin.
            </div>
          </div>
        </div>

        <!-- RIGHT PANE: Loadout Tray -->
        <div class="loadout-tray-pane" style="display: flex; flex-direction: column; gap: 16px; background: #0a0a0a; border: 2px solid #333; border-radius: 12px; padding: 16px; overflow-y: auto;">
          <h3 style="color: #fff; margin: 0 0 12px 0; font-size: 16px; text-align: center;">   LOADOUT TRAY</h3>
          
          <!-- Player Loadout -->
          <div class="loadout-section">
            <h4 style="color: #0f3; margin: 0 0 8px 0; font-size: 14px;">Player Items</h4>
            <div id="playerLoadoutDisplay" style="display: flex; flex-direction: column; gap: 8px; min-height: 40px;">
              <div style="color: #666; font-size: 11px; font-style: italic; text-align: center; padding: 12px;">No items equipped</div>
            </div>
          </div>

          <!-- Opponent Loadout -->
          <div class="loadout-section">
            <h4 style="color: #f33; margin: 0 0 8px 0; font-size: 14px;">Opponent Items</h4>
            <div id="opponentLoadoutDisplay" style="display: flex; flex-direction: column; gap: 8px; min-height: 40px;">
              <div style="color: #666; font-size: 11px; font-style: italic; text-align: center; padding: 12px;">No items equipped</div>
            </div>
          </div>

          <!-- Tag Groups (Future Implementation) -->
          <div class="tag-groups" style="display: none;">
            <h4 style="color: #fa0; margin: 12px 0 8px 0; font-size: 14px;">By Category</h4>
            <div class="tag-group" data-tag="Food">
              <div class="tag-header" style="background: #95d5b2; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">   Food</div>
              <div class="tag-items" style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;"></div>
            </div>
            <!-- More tag groups will be added -->
          </div>
        </div>

      </div>
    </section>
  </div>

  <!-- RIGHT / OPPONENT -->
  <section class="panel" id="panelO">
    <div class="title">Oils</div>
    <div class="oils" id="oilsO">
      <div class="oil" data-kind="attack"><img src="assets/attack.png"><span>Attack Oil</span></div>
      <div class="oil" data-kind="armor"><img src="assets/armor.png"><span>Armor Oil</span></div>
      <div class="oil" data-kind="speed"><img src="assets/speed.png"><span>Speed Oil</span></div>
    </div>
    <div class="weapon-slot" id="weaponO">Drop a Weapon</div>
    <div class="edge-tile">
      <div class="edge-body">
        <img id="edgeOIcon" src="assets/placeholder.png" alt="">
        <select id="edgeO"><option value="">  " Select Edge   "</option></select>
      </div>
      <div id="edgeOEffect" class="meta effect"></div>
    </div>
    <div class="selIndicator" id="selOI">Selected: None</div>
    <div class="grid12" id="gridO"></div>
    <div class="stats">
      <div class="stat"><img src="assets/health.png" alt="health"><span id="oH">10</span></div>
      <div class="stat"><img src="assets/attack.png" alt="atk"><span id="oA">0</span></div>
      <div class="stat"><img src="assets/armor.png" alt="arm"><span id="oR">0</span></div>
      <div class="stat"><img src="assets/speed.png" alt="spd"><span id="oS">0</span></div>
    </div>
    <div class="setsBox" id="setsO"></div>
  </section>
</div>

<!-- Simulation panel removed from bottom of page -->

<div id="detailModal">
  <div id="detailBox">
    <button id="detailClose">Close</button>
    <h2 id="detailName"></h2>
    <div id="detailEffect"></div>
    <div id="detailStats"></div>
  </div>
</div>

<!-- Data loader: Ensure details.js executes before inline scripts so window.HEIC_DETAILS is ready -->
<script src="details.js"></script>
<script src="heic_sim.js" defer></script>
<script src="heic_effects.js"></script>
<script src="heic_sets.js"></script>

<script>
/* Battle Replay System - Icon Renderer Module */
const BattleIconRenderer = {
  // Map action types and events to icon paths
  ICON_MAP: {
    // Combat actions
    'attack': 'assets/attack.png',
    'hit': 'assets/attack.png',
    'strike': 'assets/attack.png',
    'damage': 'assets/attack.png',
    
    // Healing and recovery
    'heal': 'assets/health.png',
    'regen': 'assets/health.png',
    'recovery': 'assets/health.png',
    
    // Defense
    'armor': 'assets/armor.png',
    'shield': 'assets/armor.png',
    'block': 'assets/armor.png',
    
    // Speed and movement
    'speed': 'assets/speed.png',
    'haste': 'assets/speed.png',
    'slow': 'assets/speed.png',
    
    // Status effects - use item icons when available
    'poison': 'items/poisonous_mushroom/icon.png',
    'thorns': 'items/bramble_vest/icon.png',
    'fire': 'items/cherry_bomb/icon.png',
    'explosion': 'items/cherry_bomb/icon.png',
    
    // Default fallbacks
    'effect': 'assets/placeholder.png',
    'item': 'assets/placeholder.png',
    'weapon': 'assets/attack.png',
    'turn': 'assets/speed.png'
  },
  
  // Extract action type from log text
  getActionFromText(text) {
    const lowerText = text.toLowerCase();
    
    // Check for specific patterns
    if (lowerText.includes('hits') || lowerText.includes('attacks') || lowerText.includes('strikes')) return 'attack';
    if (lowerText.includes('heals') || lowerText.includes('recovers')) return 'heal';
    if (lowerText.includes('gains') && lowerText.includes('armor')) return 'armor';
    if (lowerText.includes('gains') && lowerText.includes('speed')) return 'speed';
    if (lowerText.includes('poison')) return 'poison';
    if (lowerText.includes('thorns')) return 'thorns';
    if (lowerText.includes('explosion') || lowerText.includes('explodes')) return 'explosion';
    if (lowerText.includes('turn') && lowerText.includes('--')) return 'turn';
    
    // Extract item references (::icon:items/name::)
    const iconMatch = lowerText.match(/::icon:(items|weapons)\/([^:]+)::/);
    if (iconMatch) {
      return `${iconMatch[1]}/${iconMatch[2]}/icon.png`;
    }
    
    return 'effect'; // default
  },
  
  // Create icon element for log entry
  createIcon(actionType, fallbackText = '') {
    const iconPath = this.ICON_MAP[actionType] || actionType;
    const img = document.createElement('img');
    img.className = 'log-icon';
    img.src = iconPath;
    img.alt = actionType;
    
    // Fallback to placeholder if icon fails to load
    img.onerror = () => {
      if (img.src !== this.ICON_MAP.effect) {
        img.src = this.ICON_MAP.effect;
      }
    };
    
    return img;
  },
  
  // Render icons for a log entry element
  renderIcons(entryEl, logText) {
    // Remove existing icons
    const existingIcons = entryEl.querySelectorAll('.log-icon');
    existingIcons.forEach(icon => icon.remove());
    
    // Don't add icons to dividers or special entries
    if (entryEl.classList.contains('battle-divider')) return;
    
    const actionType = this.getActionFromText(logText);
    const icon = this.createIcon(actionType, logText);
    
    // Insert icon at the beginning of the entry
    entryEl.insertBefore(icon, entryEl.firstChild);
  }
};
</script>

<script>
/* Battle Replay System - State Manager Module */
const BattleStateManager = {
  logEntries: [],
  stateSnapshots: [],
  battleData: null,
  
  // Initialize with battle result data
  initBattle(simulationResult) {
    this.logEntries = [];
    this.stateSnapshots = [];
    this.battleData = simulationResult;
    
    if (simulationResult.log && Array.isArray(simulationResult.log)) {
      // Process log entries into structured format
      simulationResult.log.forEach((line, index) => {
        if (line && line.trim()) {
          this.logEntries.push({
            index,
            text: line,
            type: this.classifyLogLine(line),
            hp: this.extractHPFromLine(line)
          });
        }
      });
    }
    
    // Create state snapshots (simplified for now)
    this.createStateSnapshots();
  },
  
  // Classify log line type for styling
  classifyLogLine(line) {
    const lineStr = String(line);
    if (lineStr.includes('   ') || lineStr.includes('BATTLE')) return 'major-divider';
    if (lineStr.match(/^\d+\.\s*--\s*Turn\s+\d+\s*--/)) return 'turn-header';
    if (lineStr.includes('Player') || lineStr.includes('Fighter')) return 'player';
    if (lineStr.includes('Opponent') || lineStr.includes('Enemy')) return 'opponent';
    return 'system';
  },
  
  // Extract HP information from log line
  extractHPFromLine(line) {
    const hpMatch = line.match(/\[PlayerHP:\s*(\d+)\s*\|\s*OpponentHP:\s*(\d+)\]/);
    if (hpMatch) {
      return {
        player: parseInt(hpMatch[1], 10),
        opponent: parseInt(hpMatch[2], 10)
      };
    }
    return null;
  },
  
  // Create state snapshots for each turn
  createStateSnapshots() {
    // For now, create simple snapshots
    // This could be enhanced to capture actual fighter states
    this.logEntries.forEach((entry, index) => {
      this.stateSnapshots.push({
        index,
        turnNumber: this.getTurnNumber(entry.text),
        hp: entry.hp,
        timestamp: Date.now()
      });
    });
  },
  
  // Extract turn number from log text
  getTurnNumber(text) {
    const turnMatch = text.match(/Turn\s+(\d+)/);
    return turnMatch ? parseInt(turnMatch[1], 10) : 0;
  },
  
  // Get log entry by index
  getLogEntry(index) {
    return this.logEntries[index] || null;
  },
  
  // Get state snapshot by index
  getStateSnapshot(index) {
    return this.stateSnapshots[index] || null;
  },
  
  // Get total number of entries
  getTotalEntries() {
    return this.logEntries.length;
  },
  
  // Check if battle data is loaded
  isLoaded() {
    return this.battleData !== null && this.logEntries.length > 0;
  }
};
</script>

<script>
/* Battle Replay System - Replay Controller Module */
const BattleReplayController = {
  currentIndex: 0,
  isPlaying: false,
  playbackSpeed: 1000, // ms between turns
  playbackTimer: null,
  elements: {},
  
  // Initialize replay controller
  init() {
    this.elements = {
      controls: document.getElementById('replayControls'),
      first: document.getElementById('replayFirst'),
      back: document.getElementById('replayBack'),
      play: document.getElementById('replayPlay'),
      forward: document.getElementById('replayForward'),
      last: document.getElementById('replayLast'),
      turnInput: document.getElementById('turnInput'),
      turnTotal: document.getElementById('turnTotal'),
      speedSelect: document.getElementById('replaySpeed'),
      log: document.getElementById('simLog')
    };
    
    this.setupEventListeners();
    this.hide();
  },
  
  // Setup event listeners for controls
  setupEventListeners() {
    if (!this.elements.first) return;
    
    this.elements.first.addEventListener('click', () => this.goToFirst());
    this.elements.back.addEventListener('click', () => this.stepBack());
    this.elements.play.addEventListener('click', () => this.togglePlayback());
    this.elements.forward.addEventListener('click', () => this.stepForward());
    this.elements.last.addEventListener('click', () => this.goToLast());
    
    this.elements.turnInput.addEventListener('change', () => this.goToTurn());
    this.elements.speedSelect.addEventListener('change', () => this.updateSpeed());
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => this.handleKeyboard(e));
  },
  
  // Handle keyboard shortcuts
  handleKeyboard(e) {
    if (!this.isVisible() || e.target.tagName === 'INPUT') return;
    
    switch(e.key) {
      case 'ArrowLeft':
        e.preventDefault();
        this.stepBack();
        break;
      case 'ArrowRight':
        e.preventDefault();
        this.stepForward();
        break;
      case ' ':
        e.preventDefault();
        this.togglePlayback();
        break;
      case 'Home':
        e.preventDefault();
        this.goToFirst();
        break;
      case 'End':
        e.preventDefault();
        this.goToLast();
        break;
    }
  },
  
  // Initialize replay with battle data
  loadBattle(simulationResult) {
    BattleStateManager.initBattle(simulationResult);
    
    if (!BattleStateManager.isLoaded()) {
      this.hide();
      return;
    }
    
    this.currentIndex = 0;
    this.updateTurnCounter();
    this.renderBattleLog();
    this.show();
    this.updateControls();
  },
  
  // Render the complete battle log with replay features
  renderBattleLog() {
    if (!this.elements.log) return;
    
    this.elements.log.innerHTML = '';
    const totalEntries = BattleStateManager.getTotalEntries();
    
    for (let i = 0; i < totalEntries; i++) {
      const entry = BattleStateManager.getLogEntry(i);
      if (!entry) continue;
      
      const div = document.createElement('div');
      div.className = `battle-log-line ${entry.type}`;
      div.dataset.index = i;
      div.innerHTML = entry.text;
      
      // Add turn marker
      const marker = document.createElement('div');
      marker.className = 'turn-marker';
      div.appendChild(marker);
      
      // Add HP tracker if available
      if (entry.hp) {
        const hpTracker = document.createElement('span');
        hpTracker.className = 'hp-tracker';
        hpTracker.innerHTML = ` [P:${entry.hp.player} | O:${entry.hp.opponent}]`;
        div.appendChild(hpTracker);
      }
      
      // Add click listener for direct navigation
      div.addEventListener('click', () => this.goToIndex(i));
      
      // Render appropriate icon
      BattleIconRenderer.renderIcons(div, entry.text);
      
      this.elements.log.appendChild(div);
    }
    
    // Highlight current entry
    this.highlightCurrentEntry();
  },
  
  // Highlight the current log entry
  highlightCurrentEntry() {
    if (!this.elements.log) return;
    
    // Remove previous highlights
    const previous = this.elements.log.querySelectorAll('.battle-log-line.active');
    previous.forEach(el => el.classList.remove('active'));
    
    // Highlight current entry
    const current = this.elements.log.querySelector(`[data-index="${this.currentIndex}"]`);
    if (current) {
      current.classList.add('active');
      current.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  },
  
  // Navigation methods
  goToFirst() {
    this.currentIndex = 0;
    this.updateView();
  },
  
  goToLast() {
    this.currentIndex = Math.max(0, BattleStateManager.getTotalEntries() - 1);
    this.updateView();
  },
  
  stepBack() {
    if (this.currentIndex > 0) {
      this.currentIndex--;
      this.updateView();
    }
  },
  
  stepForward() {
    const total = BattleStateManager.getTotalEntries();
    if (this.currentIndex < total - 1) {
      this.currentIndex++;
      this.updateView();
    }
  },
  
  goToIndex(index) {
    const total = BattleStateManager.getTotalEntries();
    this.currentIndex = Math.max(0, Math.min(total - 1, index));
    this.updateView();
  },
  
  goToTurn() {
    const turnNumber = parseInt(this.elements.turnInput.value, 10) - 1;
    this.goToIndex(turnNumber);
  },
  
  // Playback control
  togglePlayback() {
    if (this.isPlaying) {
      this.stopPlayback();
    } else {
      this.startPlayback();
    }
  },
  
  startPlayback() {
    this.isPlaying = true;
    this.elements.play.textContent = '  ';
    this.elements.play.setAttribute('aria-label', 'Pause auto-play');
    
    this.playbackTimer = setInterval(() => {
      if (this.currentIndex >= BattleStateManager.getTotalEntries() - 1) {
        this.stopPlayback();
        return;
      }
      this.stepForward();
    }, this.playbackSpeed);
  },
  
  stopPlayback() {
    this.isPlaying = false;
    this.elements.play.textContent = '  ';
    this.elements.play.setAttribute('aria-label', 'Auto-play battle');
    
    if (this.playbackTimer) {
      clearInterval(this.playbackTimer);
      this.playbackTimer = null;
    }
  },
  
  updateSpeed() {
    this.playbackSpeed = parseInt(this.elements.speedSelect.value, 10);
    
    // Restart playback with new speed if currently playing
    if (this.isPlaying) {
      this.stopPlayback();
      this.startPlayback();
    }
  },
  
  // UI updates
  updateView() {
    this.highlightCurrentEntry();
    this.updateTurnCounter();
    this.updateControls();
  },
  
  updateTurnCounter() {
    const total = BattleStateManager.getTotalEntries();
    this.elements.turnInput.value = this.currentIndex + 1;
    this.elements.turnInput.max = total;
    this.elements.turnTotal.textContent = `/ ${total}`;
  },
  
  updateControls() {
    const total = BattleStateManager.getTotalEntries();
    const isFirst = this.currentIndex === 0;
    const isLast = this.currentIndex >= total - 1;
    
    this.elements.first.disabled = isFirst;
    this.elements.back.disabled = isFirst;
    this.elements.forward.disabled = isLast;
    this.elements.last.disabled = isLast;
  },
  
  // Visibility control
  show() {
    if (this.elements.controls) {
      this.elements.controls.style.display = 'block';
    }
  },
  
  hide() {
    if (this.elements.controls) {
      this.elements.controls.style.display = 'none';
    }
    this.stopPlayback();
  },
  
  isVisible() {
    return this.elements.controls && 
           this.elements.controls.style.display !== 'none';
  },
  
  // Cleanup
  destroy() {
    this.stopPlayback();
    // Remove event listeners if needed
  }
};
</script>

<script src="app.js"></script>

</body>
</html>



