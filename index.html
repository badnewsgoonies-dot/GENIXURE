<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>He Is Coming   Loadout Builder (v5)</title>
<script src="https://cdn.tailwindcss.com"></script>


<script>
// Render compendium grid (restored visually rich card UI)
function clearTransientCompendiumWarnings() {
  // Remove any debug banners or transient warnings
  const banners = document.querySelectorAll('.debug-banner, .transient-warning, .error-banner, #nonBlockingErrorBanner');
  banners.forEach(banner => banner.remove());
}

function renderCompendiumGrid() {
  // Clear any transient warnings before rendering
  if (typeof clearTransientCompendiumWarnings === 'function') {
    clearTransientCompendiumWarnings();
  }
  const grid = document.getElementById('itemGrid');
  grid.innerHTML = '';
  const items = Object.values(window.HEIC_DETAILS || {});
  items.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';
    card.tabIndex = 0;
    card.setAttribute('data-cat', (item.tags && item.tags[0]) || '');
    // Icon
    const iconWrap = document.createElement('div');
    card.className = 'iconWrap';
    const icon = document.createElement('img');
</head>
<body class="bg-black text-gray-200 min-h-screen">
<div class="frame flex flex-row w-full min-h-screen">
  <!-- LEFT / PLAYER -->
  <section class="panel flex flex-col bg-gray-900 border-r-2 border-gray-800 p-4 w-80 min-h-screen" id="panelP">
    <div class="title">Oils</div>
    <div class="oils" id="oilsP">
      <div class="oil" data-kind="attack"><img src="assets/attack.png"><span>Attack Oil</span></div>
      <div class="oil" data-kind="armor"><img src="assets/armor.png"><span>Armor Oil</span></div>
      <div class="oil" data-kind="speed"><img src="assets/speed.png"><span>Speed Oil</span></div>
    </div>
    <div class="weapon-slot" id="weaponP">Drop a Weapon</div>
    <div class="edge-tile">
      <div class="edge-body">
        <img id="edgePIcon" src="assets/placeholder.png" alt="">
        <select id="edgeP"><option value="">  " Select Edge   "</option></select>
      </div>
      <div id="edgePEffect" class="meta effect"></div>
    </div>
    <div class="selIndicator" id="selPI">Selected: None</div>
    <div class="grid12" id="gridP"></div>
    <div class="stats">
      <div class="stat"><img src="assets/health.png" alt="health"><span id="pH">10</span></div>
      <div class="stat"><img src="assets/attack.png" alt="atk"><span id="pA">0</span></div>
      <div class="stat"><img src="assets/armor.png" alt="arm"><span id="pR">0</span></div>
      <div class="stat"><img src="assets/speed.png" alt="spd"><span id="pS">0</span></div>
    </div>
    <div class="setsBox" id="setsP"></div>
  </section>

  <!-- CENTER COLUMN -->
  <div class="col-span-1 flex flex-col h-full min-h-0 flex-1">
    <div class="tabs flex gap-0.5 mb-2">
      <button id="tabCompendium" class="tabBtn bg-gray-900 text-red-400 border-2 border-red-400 rounded-t-lg px-6 py-2 cursor-pointer text-lg">Compendium</button>
      <button id="tabAnalysis" class="tabBtn bg-gray-900 text-yellow-400 border-2 border-yellow-400 rounded-t-lg px-6 py-2 cursor-pointer text-lg">Analysis</button>
      <button id="tabSimulation" class="tabBtn bg-gray-900 text-green-400 border-2 border-green-400 rounded-t-lg px-6 py-2 cursor-pointer text-lg">Simulation</button>
    </div>
  <section class="center flex-1 flex flex-col min-h-0 bg-gray-950 rounded-xl border-2 border-gray-800" id="compendiumTab">
      <!-- Advanced Compendium Header -->

      <div class="compendium-header bg-gradient-to-br from-slate-800 to-slate-900 p-4 border-b-2 border-red-400 flex-shrink-0 hidden">
        <!-- Top Row: Search + View Controls -->
        <div class="flex gap-3 items-center mb-3 flex-wrap">
          <!-- Global Search with Chips -->
          <div class="flex items-center gap-2 flex-1 min-w-[300px]">
            <input id="globalSearch" type="search" placeholder="Search items, effects, tags..." class="flex-1 bg-black text-red-500 border-2 border-red-500 rounded-lg px-3 py-2 text-sm" />
            <div id="searchChips" class="flex gap-1 flex-wrap"></div>
            <!-- Compendium Tools (Randomizer) -->
            <div id="compendiumTools" class="flex gap-2 items-center px-3 py-2 border-b border-gray-800 bg-black"></div>
          </div>
          <!-- View Switch -->
          <div class="view-switch flex gap-0.5 bg-black border-2 border-red-500 rounded-lg overflow-hidden">
            <button id="viewCards" class="view-btn active px-4 py-2 bg-red-500 text-black border-none cursor-pointer text-xs font-semibold">Cards</button>
            <button id="viewTable" class="view-btn px-4 py-2 bg-transparent text-red-500 border-none cursor-pointer text-xs font-semibold">Table</button>
          </div>
        </div>
        
        <!-- Bottom Row: Quick Actions + Stats -->
        <div style="display: flex; gap: 12px; align-items: center; justify-content: space-between;">
          
          <!-- Quick Actions -->
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button id="showSimBtn" type="button" style="background:#0f3;color:#000;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:12px;font-weight:600;">   Battle</button>
            
            <!-- QA & Authoring Tools -->
            <div style="border-left: 1px solid #666; padding-left: 8px; margin-left: 8px; display: flex; gap: 6px;">
              <button id="bulkSelectAll" title="Select all visible items" style="background: transparent; color: #0f3; border: 1px solid #0f3; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">All</button>
              <button id="bulkSelectNone" title="Clear all selections" style="background: transparent; color: #f30; border: 1px solid #f30; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">None</button>
              <button id="exportSelected" title="Export selected items as JSON" style="background: transparent; color: #fa0; border: 1px solid #fa0; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Export</button>
            </div>
          </div>
          
          <!-- Summary Stats (simplified: total only) -->
          <div style="display: flex; gap: 8px; align-items: center; font-size: 12px;">
            <span style="color: #aaa;">Total:</span>
            <span id="totalCount" style="color: #fff; font-weight: 700;">0</span>
          </div>
          
        </div>
      </div>
      
      <!-- Main Content Layout -->
  <div class="compendium-main flex flex-1 min-h-0 overflow-hidden">
        
        <!-- Left Facet Panel -->
        <div class="facet-panel w-[280px] bg-black border-r-2 border-gray-800 overflow-y-auto p-4 flex-shrink-0">
          
          <!-- Bucket Filter -->
          <div class="facet-group" style="margin-bottom: 20px;">
            <h4 style="color: #f33; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Bucket</h4>
            <div class="bucket-filters" style="display: flex; flex-direction: column; gap: 4px;">
              <label class="facet-option active" style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; background: rgba(255,51,51,0.1); border-left: 3px solid #f33;">
                <input type="checkbox" name="bucket" value="all" checked style="accent-color: #f33;">
                <span style="color: #f33; font-weight: 600;">All Items</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" name="bucket" value="items" style="accent-color: #f33;">
                <span>Items</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" name="bucket" value="weapons" style="accent-color: #f33;">
                <span>Weapons</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" name="bucket" value="upgrades" style="accent-color: #f33;">
                <span>Upgrades</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
            </div>
          </div>
          
          <!-- Tag Families -->
          <div class="facet-group" style="margin-bottom: 20px;">
            <h4 style="color: #f33; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Tag Families</h4>
            <div class="tag-families" style="display: flex; flex-direction: column; gap: 2px;">
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Tome" style="accent-color: #73d2de;">
                <span>   Tome</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Bomb" style="accent-color: #ff9500;">
                <span>   Bomb</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Symphony" style="accent-color: #9c88ff;">
                <span>   Symphony</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Food" style="accent-color: #95d5b2;">
                <span>   Food</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Jewelry" style="accent-color: #ffd166;">
                <span>   Jewelry</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Ring" style="accent-color: #ffd166;">
                <span>   Ring</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Stone" style="accent-color: #8b4513;">
                <span>   Stone</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Water" style="accent-color: #4169e1;">
                <span>   Water</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Wood" style="accent-color: #8b5a2b;">
                <span>   Wood</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Rune" style="accent-color: #00ced1;">
                <span>   Rune</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Potion" style="accent-color: #66ccff;">
                <span>   Potion</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Crone" style="accent-color: #c71585;">
                <span>   Crone</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Rose" style="accent-color: #ff6699;">
                <span>   Rose</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Mythic" style="accent-color: #bb86fc;">
                <span>   Mythic</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Sanguine" style="accent-color: #dc143c;">
                <span>   Sanguine</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Unique" style="accent-color: #ffaa00;">
                <span>   Unique</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="tag" value="Forge Upgrades" style="accent-color: #f4a261;">
                <span>   Edge</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
            </div>
          </div>
          
          <!-- Trigger Filters -->
          <div class="facet-group" style="margin-bottom: 20px;">
            <h4 style="color: #f33; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Triggers</h4>
            <div class="trigger-filters" style="display: flex; flex-direction: column; gap: 2px;">
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="trigger" value="battleStart" style="accent-color: #0f3;">
                <span>   Battle Start</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="trigger" value="turnStart" style="accent-color: #fa0;">
                <span>  Turn Start</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="trigger" value="hit" style="accent-color: #f33;">
                <span>   On Hit</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="trigger" value="wounded" style="accent-color: #f0a;">
                <span>   On Wounded</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="trigger" value="exposed" style="accent-color: #af5;">
                <span>    On Exposed</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
              <label class="facet-option" style="display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                <input type="checkbox" name="trigger" value="passive" style="accent-color: #888;">
                <span>  Passive</span>
                <span class="count" style="margin-left: auto; color: #aaa; font-size: 10px;">0</span>
              </label>
            </div>
          </div>
          
          <!-- Sets Filter (moved from header) -->
          <div class="facet-group" style="margin-bottom: 20px;">
            <h4 style="color: #f33; margin: 0 0 8px 0; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Sets</h4>
            <div id="setsFilterContainer" class="sets-filter" style="display: flex; flex-direction: column; gap: 2px; max-height: 160px; overflow: auto;"></div>
          </div>
          <!-- Clear Filters -->
          <button id="clearAllFilters" style="
            width: 100%; 
            background: transparent; 
            color: #666; 
            border: 1px solid #666; 
            border-radius: 4px; 
            padding: 8px; 
            cursor: pointer; 
            font-size: 11px; 
            margin-top: 16px;
          ">Clear All Filters</button>
          <div style="margin-top:12px; border:1px solid #333; border-radius:6px; padding:8px;">
            <div style="color:#aaa; font-size:11px; margin-bottom:6px;">Set Bonus</div>
            <div style="color:#555; font-size:10px;">(visual indicator placeholder)</div>
          </div>
          <button id="randBuildBtn" type="button" title="Randomize Player loadout" style="margin-top:12px; width:100%; background:#000; color:#f33; border:1px solid #f33; border-radius:6px; padding:8px; cursor:pointer; font-size:12px; font-weight:700;">Random Build</button>
          <button id="randEnemyBtn" type="button" title="Randomize Opponent loadout" style="margin-top:8px; width:100%; background:#000; color:#f33; border:1px solid #f33; border-radius:6px; padding:8px; cursor:pointer; font-size:12px; font-weight:700;">Random Enemy</button>
          
        </div>
        
        <!-- Main Content Area -->
  <div class="main-content flex flex-1 flex-col min-h-0">
          
          <!-- Cards View (Default) -->
          <div id="cardsView" class="content-view flex-1 overflow-y-auto p-4">
            <div id="itemGrid" class="grid grid-cols-[repeat(auto-fit,minmax(320px,1fr))] gap-3 justify-stretch content-start"></div>
          </div>
          
          <!-- Table View (Hidden by default) -->
          <div id="tableView" class="content-view" style="display: none; flex: 1; overflow: auto; padding: 16px;">
            <table id="itemTable" style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead>
                <tr style="background: rgba(255,255,255,0.05); position: sticky; top: 0;">
                  <th style="text-align: left; padding: 8px; border-bottom: 1px solid #333; color: #f33;">Name</th>
                  <th style="text-align: left; padding: 8px; border-bottom: 1px solid #333; color: #f33;">Bucket</th>
                  <th style="text-align: left; padding: 8px; border-bottom: 1px solid #333; color: #f33;">Tags</th>
                  <th style="text-align: center; padding: 8px; border-bottom: 1px solid #333; color: #f33;">Triggers</th>
                  <th style="text-align: center; padding: 8px; border-bottom: 1px solid #333; color: #f33;">ATK</th>
                  <th style="text-align: center; padding: 8px; border-bottom: 1px solid #333; color: #f33;">ARM</th>
                  <th style="text-align: center; padding: 8px; border-bottom: 1px solid #333; color: #f33;">HP</th>
                  <th style="text-align: center; padding: 8px; border-bottom: 1px solid #333; color: #f33;">SPD</th>
                  <th style="text-align: left; padding: 8px; border-bottom: 1px solid #333; color: #f33;">Effect</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
          
          <!-- Compare View (Hidden by default) -->
          <div id="compareView" class="content-view" style="display: none; flex: 1; overflow: auto; padding: 16px;">
            <div class="compare-header" style="text-align: center; margin-bottom: 20px;">
              <h3 style="color: #f33; margin: 0;">Compare Items</h3>
              <p style="color: #aaa; font-size: 12px; margin: 8px 0;">Select 2-3 items from the Cards view to compare side-by-side</p>
            </div>
            <div id="compareContent" style="display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
              <div style="color: #666; font-style: italic; grid-column: 1/-1; text-align: center; padding: 40px;">No items selected for comparison</div>
            </div>
          </div>
          
        </div>
        
      </div>
    </section>
    <section class="center" id="analysisTab" style="flex:1; display:none; flex-direction:column; min-height:0;">
      <!-- Battle Analysis Header -->
      <div class="analysis-header" style="background: linear-gradient(135deg, #1a1f2e 0%, #16202d 100%); padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <h2 style="color: #fff; font-size: 24px; margin: 0; text-align: center;">Battle Analysis</h2>
        <p style="color: #aaa; font-size: 14px; margin: 8px 0 0 0; text-align: center;">Turn raw logs into insight: KPIs, breakdowns, and clear recommendations</p>
      </div>
      
      <!-- Outcome KPIs Sticky Strip -->
      <div id="outcomeKPIs" class="outcome-kpis" style="
        background: rgba(0,0,0,0.8); 
        padding: 12px 16px; 
        border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
        justify-content: center;
        position: sticky;
        top: 0;
        z-index: 10;
      ">
        <div class="kpi-item">
          <div class="kpi-label">TTK</div>
          <div class="kpi-value" id="kpiTTK">-</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-label">Survived</div>
          <div class="kpi-value" id="kpiSurvived">-</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-label">Damage Dealt</div>
          <div class="kpi-value" id="kpiDamageDealt">-</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-label">Damage Taken</div>
          <div class="kpi-value" id="kpiDamageTaken">-</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-label">Strike Uptime</div>
          <div class="kpi-value" id="kpiStrikeUptime">-</div>
        </div>
        <div class="kpi-item">
          <div class="kpi-label">Net Tempo</div>
          <div class="kpi-value" id="kpiNetTempo">-</div>
        </div>
      </div>
      
      <!-- Main Analysis Content -->
      <div class="analysis-content" style="
        flex: 1; 
        overflow: auto; 
        padding: 16px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
      ">
        
        <!-- Left Column -->
        <div class="analysis-left">
          
          <!-- Damage Sources Panel -->
          <div class="analysis-panel" id="damageSources">
            <div class="analysis-panel-header">
              <h3>Damage Sources</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div class="damage-chart" id="damageChart"></div>
              <div class="damage-list" id="damageList"></div>
            </div>
          </div>
          
          <!-- Status Impact Panel -->
          <div class="analysis-panel" id="statusImpact">
            <div class="analysis-panel-header">
              <h3>Status Impact</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div id="statusBreakdown"></div>
            </div>
          </div>
          
          <!-- Armor Economy Panel -->
          <div class="analysis-panel" id="armorEconomy">
            <div class="analysis-panel-header">
              <h3>Armor Economy</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div id="armorFlow"></div>
            </div>
          </div>
          
        </div>
        
        <!-- Right Column -->
        <div class="analysis-right">
          
          <!-- Trigger Heatmap Panel -->
          <div class="analysis-panel" id="triggerHeatmap">
            <div class="analysis-panel-header">
              <h3>Trigger Heatmap</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div id="heatmapMatrix"></div>
            </div>
          </div>
          
          <!-- Synergy Detection Panel -->
          <div class="analysis-panel" id="synergyDetection">
            <div class="analysis-panel-header">
              <h3>Synergy Analysis</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div id="synergyCallouts"></div>
              <div id="antiSynergyWarnings"></div>
            </div>
          </div>
          
          <!-- Bottlenecks & Risks Panel -->
          <div class="analysis-panel" id="bottlenecks">
            <div class="analysis-panel-header">
              <h3>Bottlenecks & Risks</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div id="limitingFactors"></div>
              <div id="riskAlerts"></div>
            </div>
          </div>
          
          <!-- Recommendations Panel -->
          <div class="analysis-panel" id="recommendations">
            <div class="analysis-panel-header">
              <h3>Recommendations</h3>
              <button class="analysis-toggle"> </button>
            </div>
            <div class="analysis-panel-content">
              <div id="recommendationList"></div>
            </div>
          </div>
          
        </div>
        
      </div>
      
      <!-- Why Inspector Side Panel -->
      <div id="whyInspector" class="why-inspector fixed top-0 right-[-400px] w-[400px] h-screen bg-slate-800 border-l border-white/20 z-50 transition-all duration-300 overflow-y-auto">
        <div class="why-header flex justify-between items-center p-4 bg-white/5 border-b border-white/10">
          <h3 class="m-0 text-white text-base">Why Inspector</h3>
          <button id="closeWhyInspector" class="bg-none border-none text-gray-400 text-xl cursor-pointer p-0 w-6 h-6 hover:text-white">�</button>
        </div>
        <div class="why-content p-4">
          <div id="causalChain"></div>
          <div id="neighbors"></div>
          <div id="firstTurnView"></div>
        </div>
      </div>
      
    </section>
    <section class="center flex-1 hidden flex-col min-h-0 bg-black" id="simulationTab">
      <!-- Three-Pane Layout: Fighter Cards | Event Log | Loadout Tray -->
      <div class="sim-three-pane grid grid-cols-[0_1fr_380px] gap-3 h-full min-h-0 p-3">
        <!-- LEFT PANE: (hidden, reserved for future) -->
        <div class="fighter-summary-pane" style="display: none;"></div>

        <!-- MIDDLE PANE: Event Log, Arena, and Battle Controls -->
        <div class="event-log-pane flex flex-col bg-gray-900 border-2 border-gray-700 rounded-xl overflow-hidden min-h-0 col-start-2 relative z-10">
          <!-- Log Header -->
          <div class="bg-gradient-to-r from-gray-700 to-gray-600 py-3 px-4 border-b-2 border-gray-700 flex-shrink-0">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <h3 style="color: #fff; font-size: 16px; font-weight: 700; margin: 0;">   EVENT LOG</h3>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div id="battleStatus" style="color: #ccc; font-size: 12px; font-weight: 600;">Ready</div>
                <button id="btnSimulateTop" type="button" title="Run a battle" class="bg-green-400 text-black border-none rounded-md px-3 py-2 cursor-pointer text-xs font-bold">START BATTLE</button>
                <button id="randBuildBtn" type="button" title="Randomize player loadout" class="bg-cyan-400 text-white border-none rounded-md px-3 py-2 cursor-pointer text-xs font-bold">?? Randomize Player</button>
                <button id="randEnemyBtn" type="button" title="Randomize opponent loadout" class="bg-red-400 text-white border-none rounded-md px-3 py-2 cursor-pointer text-xs font-bold">?? Randomize Opponent</button>
              </div>
            </div>
          </div>

          <!-- Timeline Controls -->
          <div id="timelineControls" style="display: none; background: rgba(0,20,0,0.8); border-bottom: 2px solid #0a5; padding: 12px 16px; flex-shrink: 0;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 6px;">
                <button id="replayFirst" class="replay-btn" style="background: #0a5; color: #000; border: none; border-radius: 4px; padding: 6px 8px; cursor: pointer; font-size: 11px; font-weight: 700;">??</button>
                <button id="replayBack" class="replay-btn" style="background: #0a5; color: #000; border: none; border-radius: 4px; padding: 6px 8px; cursor: pointer; font-size: 11px; font-weight: 700;">&lt;&lt;</button>
                <button id="replayPlay" class="replay-btn" style="background: #0f3; color: #000; border: none; border-radius: 4px; padding: 6px 8px; cursor: pointer; font-size: 11px; font-weight: 700;">??</button>
                <button id="replayForward" class="replay-btn" style="background: #0a5; color: #000; border: none; border-radius: 4px; padding: 6px 8px; cursor: pointer; font-size: 11px; font-weight: 700;">&gt;&gt;</button>
                <button id="replayLast" class="replay-btn" style="background: #0a5; color: #000; border: none; border-radius: 4px; padding: 6px 8px; cursor: pointer; font-size: 11px; font-weight: 700;">??</button>
              </div>
              <div style="display: flex; align-items: center; gap: 6px; color: #0f3; font-size: 11px;">
                <label>Turn:</label>
                <input id="turnInput" type="number" min="1" value="1" style="width: 50px; background: #000; color: #0f3; border: 1px solid #0a5; border-radius: 4px; padding: 4px 6px; font-size: 11px; text-align: center;">
                <span id="turnTotal">/ 0</span>
              </div>
              <div style="display: flex; align-items: center; gap: 6px; color: #0f3; font-size: 11px;">
                <label>Speed:</label>
                <select id="replaySpeed" style="background: #000; color: #0f3; border: 1px solid #0a5; border-radius: 4px; padding: 2px 4px; font-size: 11px;">
                  <option value="2000">0.5�</option>
                  <option value="1000" selected>1�</option>
                  <option value="500">2�</option>
                  <option value="250">4�</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Battle Log Content -->
          <div id="simLog" class="flex-1 overflow-y-auto p-4 text-sm text-gray-300 leading-relaxed min-h-0" aria-live="polite">
            <div style="text-align: center; color: #666; font-style: italic; padding: 40px 20px;">
              <img src="assets/attack.png" style="width: 16px; height: 16px; vertical-align: middle; image-rendering: pixelated;"> Ready to witness epic battles!<br><br>
              Configure your loadouts and hit <strong style="color: #0f3;">"START BATTLE"</strong> to begin.
            </div>
          </div>

          <!-- Arena below the log -->
          <style id="arenaStyles">
            #arenaBoard{background:rgba(255,255,255,0.02); border-top:2px solid rgba(255,255,255,0.06); margin-top:8px; --arena-box-min-height:540px; --arena-sprite-height:192px}
            #arenaBoard .pill{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:8px;background:#0b0b0b}
            #arenaBoard .status-chip{background:#0b0b0b}
            #arenaBoard img{image-rendering:pixelated}
            .arena-overlay{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:8px;font-weight:700;visibility:hidden;box-shadow:0 2px 10px rgba(0,0,0,.35)}
            .arena-overlay img{width:16px;height:16px}
            .arena-overlay{display:none !important}
            .delta-panel{min-width:110px; min-height:60px; border:1px solid rgba(255,255,255,0.1); border-radius:10px; background:rgba(0,0,0,0.35); padding:8px; color:#ddd; display:flex; flex-direction:column; gap:4px}
            .delta-row{display:flex; align-items:center; gap:6px; font-size:13px;}
            .delta-row .icon{width:16px; height:16px; display:inline-block}
            .delta-row.positive{color:#0f3}
            .delta-row.negative{color:#f44}
            .status-bar{display:flex; gap:14px; align-items:center; justify-content:space-between; margin:4px 0 10px; width:100%; flex-wrap:nowrap}
            .status-bar .s{display:flex; align-items:center; gap:6px; color:#ddd; font-size:14px}
            .status-bar .s img{width:18px; height:18px; image-rendering:pixelated}
            #arenaPlayerAction, #arenaOpponentAction{ font-size: 15px; }
            #simulationTab .fighter-summary-pane .fighter-card, #simulationTab #pinnedMetrics{display:none !important}
            #arenaPlayerStatuses, #arenaOpponentStatuses{display:none}
          </style>

          <div id="arenaBoard" class="grid grid-cols-2 gap-6 p-4 border-t-2 border-white/10">
            <!-- Player Arena -->
            <div id="simPlayerArena" class="bg-green-400/5 border border-green-600 rounded-xl p-3 relative" style="min-height: var(--arena-box-min-height);">
              <div style="color:#ffd; font-weight:700; font-size:14px; margin-bottom:6px;">Current Status</div>
              <div id="arenaPlayerStatusBar" class="status-bar"></div>
              <div id="arenaPlayerStatuses" style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:6px 0 8px 0;"></div>
              <div id="arenaPlayerEventOverlay" class="arena-overlay" style="position:absolute; left: 50%; transform: translateX(-50%); top: 8px; background: rgba(0,255,51,0.1); border:1px solid #0f3; color:#0f3;">
                <img id="arenaPlayerEventIcon" src="assets/placeholder.png">
                <span id="arenaPlayerEventText"></span>
              </div>
              <div class="statusPanelGrid" style="display:grid; grid-template-columns: 110px 1fr 120px; align-items:center; gap:16px; height: calc(var(--arena-sprite-height) + 32px);">
                <!-- Left: vertical stat pills -->
                <div class="pills-vertical" style="display:flex; flex-direction:column; gap:10px; align-items:stretch;">
                  <div class="pill" style="justify-content:center;"><img src="assets/health.png" style="width:16px;height:16px;"><span id="arenaPlayerHP">10</span></div>
                  <div class="pill" style="justify-content:center;"><img src="assets/armor.png" style="width:16px;height:16px;"><span id="arenaPlayerArmor">0</span></div>
                  <div class="pill" style="justify-content:center;"><img src="assets/attack.png" style="width:16px;height:16px;"><span id="arenaPlayerAttack">0</span></div>
                  <div class="pill" style="justify-content:center;"><img src="assets/speed.png" style="width:16px;height:16px;"><span id="arenaPlayerSpeed">0</span></div>
                </div>
                <!-- Center: framed sprite -->
                <div class="sprite-frame" style="position:relative; display:grid; place-items:center; height:100%;">
                  <div style="position:absolute; inset:0; border:1px solid rgba(255,255,255,0.15); border-radius:12px;"></div>
                  <img id="arenaPlayerSprite" src="sprites/1.png" alt="player" style="height:var(--arena-sprite-height); width:auto; image-rendering:pixelated; filter: drop-shadow(0 0 6px #0f3);">
                </div>
                <!-- Right: delta panel -->
                <div id="arenaPlayerDelta" class="delta-panel" aria-label="Player changes"></div>
              </div>
              <div style="margin-top:12px; border-top:1px solid rgba(255,255,255,0.08); padding-top:8px; color:#ccc; font-size:13px;">
                <div style="font-weight:700; color:#0f3; margin-bottom:4px;">Action</div>
                <div id="arenaPlayerAction" style="opacity:.9"></div>
              </div>
              <!-- Player scoped event log -->
              <div id="playerSideLog" style="margin-top:12px; background: rgba(0,255,51,0.05); border:1px solid #0a5; border-radius:10px; overflow:hidden;">
                <div style="display:flex; align-items:center; justify-content:space-between; padding:6px 8px; border-bottom:1px solid #0a5;">
                  <div style="font-size:12px; font-weight:700; color:#0f3;">EVENT LOG � Player</div>
                  <div style="display:flex; gap:6px;">
                    <button id="playerFilterAll" style="font-size:11px; padding:4px 8px; border:1px solid #0a5; border-radius:6px; background:#002100; color:#0f3; cursor:pointer;">All</button>
                    <button id="playerFilterOutgoing" style="font-size:11px; padding:4px 8px; border:1px solid #0a5; border-radius:6px; background:#000; color:#0f3; cursor:pointer;">Outgoing</button>
                    <button id="playerFilterIncoming" style="font-size:11px; padding:4px 8px; border:1px solid #0a5; border-radius:6px; background:#000; color:#0f3; cursor:pointer;">Incoming</button>
                  </div>
                </div>
                <div id="playerSideLogList" style="max-height:220px; overflow:auto; padding:8px; font-size:12px; color:#ccc;"></div>
              </div>
            </div>
            <!-- Opponent Arena -->
            <div id="simOpponentArena" class="bg-red-400/5 border border-red-600 rounded-xl p-3 relative" style="min-height: var(--arena-box-min-height);">
              <div style="color:#ffd; font-weight:700; font-size:14px; margin-bottom:6px; text-align:right;">Current Status</div>
              <div id="arenaOpponentStatusBar" class="status-bar" style="justify-content:flex-end;"></div>
              <div id="arenaOpponentStatuses" style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:6px 0 8px 0;"></div>
              <div id="arenaOpponentEventOverlay" class="arena-overlay" style="position:absolute; left: 50%; transform: translateX(-50%); top: 8px; background: rgba(255,51,51,0.1); border:1px solid #f33; color:#f33;">
                <img id="arenaOpponentEventIcon" src="assets/placeholder.png">
                <span id="arenaOpponentEventText"></span>
              </div>
              <div class="statusPanelGrid" style="display:grid; grid-template-columns: 110px 1fr 120px; align-items:center; gap:16px; height: calc(var(--arena-sprite-height) + 32px);">
                <!-- Left: vertical stat pills -->
                <div class="pills-vertical" style="display:flex; flex-direction:column; gap:10px; align-items:stretch;">
                  <div class="pill" style="justify-content:center;"><img src="assets/health.png" style="width:16px;height:16px;"><span id="arenaOpponentHP">10</span></div>
                  <div class="pill" style="justify-content:center;"><img src="assets/armor.png" style="width:16px;height:16px;"><span id="arenaOpponentArmor">0</span></div>
                  <div class="pill" style="justify-content:center;"><img src="assets/attack.png" style="width:16px;height:16px;"><span id="arenaOpponentAttack">0</span></div>
                  <div class="pill" style="justify-content:center;"><img src="assets/speed.png" style="width:16px;height:16px;"><span id="arenaOpponentSpeed">0</span></div>
                </div>
                <!-- Center: framed sprite -->
                <div class="sprite-frame" style="position:relative; display:grid; place-items:center; height:100%;">
                  <div style="position:absolute; inset:0; border:1px solid rgba(255,255,255,0.15); border-radius:12px;"></div>
                  <img id="arenaOpponentSprite" src="sprites/2.png" alt="opponent" style="height:var(--arena-sprite-height); width:auto; image-rendering:pixelated; filter: drop-shadow(0 0 6px #f33);">
                </div>
                <!-- Right: delta panel -->
                <div id="arenaOpponentDelta" class="delta-panel" aria-label="Opponent changes"></div>
              </div>
              <div style="margin-top:12px; border-top:1px solid rgba(255,255,255,0.08); padding-top:8px; color:#ccc; font-size:13px; text-align:right;">
                <div style="font-weight:700; color:#f66; margin-bottom:4px;">Action</div>
                <div id="arenaOpponentAction" style="opacity:.9"></div>
              </div>
              <!-- Opponent scoped event log -->
              <div id="opponentSideLog" style="margin-top:12px; background: rgba(255,51,51,0.05); border:1px solid #a33; border-radius:10px; overflow:hidden;">
                <div style="display:flex; align-items:center; justify-content:space-between; padding:6px 8px; border-bottom:1px solid #a33;">
                  <div style="font-size:12px; font-weight:700; color:#f66;">EVENT LOG � Opponent</div>
                  <div style="display:flex; gap:6px;">
                    <button id="opponentFilterAll" style="font-size:11px; padding:4px 8px; border:1px solid #a33; border-radius:6px; background:#210000; color:#f66; cursor:pointer;">All</button>
                    <button id="opponentFilterOutgoing" style="font-size:11px; padding:4px 8px; border:1px solid #a33; border-radius:6px; background:#000; color:#f66; cursor:pointer;">Outgoing</button>
                    <button id="opponentFilterIncoming" style="font-size:11px; padding:4px 8px; border:1px solid #a33; border-radius:6px; background:#000; color:#f66; cursor:pointer;">Incoming</button>
                  </div>
                </div>
                <div id="opponentSideLogList" style="max-height:220px; overflow:auto; padding:8px; font-size:12px; color:#ccc;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT PANE: Loadout Tray -->
        <div class="loadout-tray-pane flex flex-col gap-4 bg-gray-900 border-2 border-gray-700 rounded-xl p-4 overflow-y-auto col-start-3 relative z-[1] max-w-[380px]">
          <h3 class="text-white m-0 mb-3 text-base text-center">   LOADOUT TRAY</h3>
          <!-- Player Loadout -->
          <div class="loadout-section">
            <h4 class="text-green-400 m-0 mb-2 text-sm">Player Items</h4>
            <div id="playerLoadoutDisplay" class="grid grid-cols-1 gap-2 min-h-10">
              <div class="text-gray-500 text-xs italic text-center p-3">No items equipped</div>
            </div>
          </div>
          <!-- Opponent Loadout -->
          <div class="loadout-section">
            <h4 class="text-red-400 m-0 mb-2 text-sm">Opponent Items</h4>
            <div id="opponentLoadoutDisplay" class="grid grid-cols-1 gap-2 min-h-10">
              <div class="text-gray-500 text-xs italic text-center p-3">No items equipped</div>
            </div>
          </div>
          <!-- Tag Groups (Future Implementation) -->
          <div class="tag-groups" style="display: none;">
            <h4 style="color: #fa0; margin: 12px 0 8px 0; font-size: 14px;">By Category</h4>
            <div class="tag-group" data-tag="Food">
              <div class="tag-header" style="background: #95d5b2; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">   Food</div>
              <div class="tag-items" style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;"></div>
            </div>
            <!-- More tag groups will be added -->
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- RIGHT / OPPONENT -->
  <section class="panel flex flex-col bg-gray-900 border-l-2 border-gray-800 p-4 w-80 min-h-screen" id="panelO">
    <div class="title">Oils</div>
    <div class="oils" id="oilsO">
      <div class="oil" data-kind="attack"><img src="assets/attack.png"><span>Attack Oil</span></div>
      <div class="oil" data-kind="armor"><img src="assets/armor.png"><span>Armor Oil</span></div>
      <div class="oil" data-kind="speed"><img src="assets/speed.png"><span>Speed Oil</span></div>
    </div>
    <div class="weapon-slot" id="weaponO">Drop a Weapon</div>
    <div class="edge-tile">
      <div class="edge-body">
        <img id="edgeOIcon" src="assets/placeholder.png" alt="">
        <select id="edgeO"><option value="">  " Select Edge   "</option></select>
      </div>
      <div id="edgeOEffect" class="meta effect"></div>
    </div>
    <div class="selIndicator" id="selOI">Selected: None</div>
    <div class="grid12" id="gridO"></div>
    <div class="stats">
      <div class="stat"><img src="assets/health.png" alt="health"><span id="oH">10</span></div>
      <div class="stat"><img src="assets/attack.png" alt="atk"><span id="oA">0</span></div>
      <div class="stat"><img src="assets/armor.png" alt="arm"><span id="oR">0</span></div>
      <div class="stat"><img src="assets/speed.png" alt="spd"><span id="oS">0</span></div>
    </div>
    <div class="setsBox" id="setsO"></div>
  </section>
</div>

<!-- Simulation panel removed from bottom of page -->

<div id="detailModal">
  <div id="detailBox">
    <button id="detailClose">Close</button>
    <h2 id="detailName"></h2>
    <div id="detailEffect"></div>
    <div id="detailStats"></div>
  </div>
</div>

<!-- Data loader: Ensure details.js executes before inline scripts so window.HEIC_DETAILS is ready -->
<script src="details.js"></script>
<script src="heic_sim.js" defer></script>
<script src="heic_effects.js"></script>
<script src="heic_sets.js"></script>
<script src="heic_sets.generated.js"></script>

<script>
/* Battle Replay System - Icon Renderer Module */
  const BattleIconRenderer = {
  // Map action types and events to icon paths
  ICON_MAP: {
    // Combat actions
    'attack': 'assets/attack.png',
    'hit': 'assets/attack.png',
    'strike': 'assets/attack.png',
    'damage': 'assets/attack.png',
    
    // Healing and recovery
    'heal': 'assets/health.png',
    'regen': 'assets/status_regen.svg',
    'recovery': 'assets/health.png',
    
    // Defense
    'armor': 'assets/armor.png',
    'shield': 'assets/armor.png',
    'block': 'assets/armor.png',
    
    // Speed and movement
    'speed': 'assets/speed.png',
    'haste': 'assets/speed.png',
    'slow': 'assets/speed.png',
    
    // Status effects (placeholders)
    'acid': 'assets/status_acid.svg',
    'poison': 'assets/status_poison.svg',
    'thorns': 'assets/status_thorns.svg',
    'freeze': 'assets/status_freeze.svg',
    'stun': 'assets/status_stun.svg',
    'exposed': 'assets/status_exposed.svg',
    'riptide': 'assets/status_riptide.svg',
    'purity': 'assets/status_purity.svg',
    'fire': 'assets/attack.png',
    'explosion': 'assets/attack.png',
    
    // Default fallbacks
    'effect': 'assets/placeholder.png',
    'item': 'assets/placeholder.png',
    'weapon': 'assets/attack.png',
    'turn': 'assets/speed.png'
  },
  
  // Extract action type from log text
  getActionFromText(text) {
    const lowerText = text.toLowerCase();
    
    // Check for specific patterns
    if (lowerText.includes('hits') || lowerText.includes('attacks') || lowerText.includes('strikes')) return 'attack';
    if (lowerText.includes('heals') || lowerText.includes('recovers')) return 'heal';
    if (lowerText.includes('gains') && lowerText.includes('armor')) return 'armor';
    if (lowerText.includes('gains') && lowerText.includes('speed')) return 'speed';
    if (lowerText.includes('poison')) return 'poison';
    if (lowerText.includes('thorns')) return 'thorns';
    if (lowerText.includes('explosion') || lowerText.includes('explodes')) return 'explosion';
    if (lowerText.includes('turn') && lowerText.includes('--')) return 'turn';
    
    // Extract item references (::icon:items/name::)
    const iconMatch = lowerText.match(/::icon:(items|weapons)\/([^:]+)::/);
    if (iconMatch) {
      return `${iconMatch[1]}/${iconMatch[2]}/icon.png`;
    }
    
    return 'effect'; // default
  },
  
  // Create icon element for log entry
  createIcon(actionType, fallbackText = '') {
    const iconPath = this.ICON_MAP[actionType] || actionType;
    const img = document.createElement('img');
    img.className = 'log-icon';
    img.src = iconPath;
    img.alt = actionType;
    
    // Fallback to placeholder if icon fails to load
    img.onerror = () => {
      if (img.src !== this.ICON_MAP.effect) {
        img.src = this.ICON_MAP.effect;
      }
    };
    
    return img;
  },
  
  // Render icons for a log entry element
  renderIcons(entryEl, logText) {
    // Remove existing icons
    const existingIcons = entryEl.querySelectorAll('.log-icon');
    existingIcons.forEach(icon => icon.remove());
    
    // Don't add icons to dividers or special entries
    if (entryEl.classList.contains('battle-divider')) return;
    
    const actionType = this.getActionFromText(logText);
    const icon = this.createIcon(actionType, logText);
    
    // Insert icon at the beginning of the entry
    entryEl.insertBefore(icon, entryEl.firstChild);
  }
  };
  try { window.BattleIconRenderer = BattleIconRenderer; } catch(_) {}
  </script>

  <script>
  /* Battle Replay System - Visuals (per-action overlays + dynamic stats) */
  const BattleVisuals = {
    // Icons for delta rendering
    deltaIcon(key){
      const map = {
        hp: 'assets/health.png',
        armor: 'assets/armor.png',
        atk: 'assets/attack.png',
        tempAtk: 'assets/attack.png',
        speed: 'assets/speed.png',
        strikes: 'sprites/strikes.PNG',
        thorns: 'sprites/Icon_thorns.png',
        poison: 'sprites/Icon_poison.png',
        regen: 'sprites/Icon_regen.png',
        stun: 'sprites/Icon_stun.png',
        acid: 'sprites/Icon_acid.png',
        freeze: 'sprites/Icon_freeze.png',
        riptide: 'sprites/Icon_riptide.png',
        purity: 'sprites/Icon_purity.png'
      };
      return map[key] || BattleIconRenderer.ICON_MAP[key] || 'assets/placeholder.png';
    },

    // Compute a light-weight state up to a given log index
    computeState(index) {
      // Prefer full states captured during simulation
      try {
        const prev = BattleStateManager.getFullState(Math.max(0, index-1));
        const cur  = BattleStateManager.getFullState(index);
        if (cur) {
          const base = {
            player: { hp: cur.player.hp, armor: cur.player.armor, attack: cur.player.attack, speed: cur.player.speed, statuses: cur.player.statuses||{} },
            opponent: { hp: cur.opponent.hp, armor: cur.opponent.armor, attack: cur.opponent.attack, speed: cur.opponent.speed, statuses: cur.opponent.statuses||{} },
            event: { side: null, icon: 'assets/placeholder.png', text: '' }
          };
          return base;
        }
      } catch(_) {}
      const base = {
        player: { hp: 10, armor: 0, attack: 0, speed: 0, statuses: {} },
        opponent: { hp: 10, armor: 0, attack: 0, speed: 0, statuses: {} },
        event: { side: null, icon: 'assets/placeholder.png', text: '' }
      };
      if (!BattleStateManager || !BattleStateManager.isLoaded()) return base;

      // Initialize HP from first snapshot if available
      const first = BattleStateManager.getStateSnapshot(0);
      if (first && first.hp) { base.player.hp = first.hp.player; base.opponent.hp = first.hp.opponent; }

      for (let i = 0; i <= index; i++) {
        const entry = BattleStateManager.getLogEntry(i);
        if (!entry) continue;
        const t = (entry.text || '').toString();

        // Update HP when present
        if (entry.hp) { base.player.hp = entry.hp.player; base.opponent.hp = entry.hp.opponent; }

        // Parse simple deltas
        const gainArmor = t.match(/(Player|Opponent) gains\s+(\d+)\s+armor/i);
        if (gainArmor) {
          const who = gainArmor[1].toLowerCase() === 'player' ? 'player' : 'opponent';
          const amt = parseInt(gainArmor[2], 10);
          base[who].armor += amt;
          if (i === index) base.event = { side: who, icon: 'assets/armor.png', text: `+${amt} armor` };
        }

        const loseArmor = t.match(/(Player|Opponent) loses\s+(\d+)\s+armor/i) || t.match(/destroys\s+(\d+)\s+armor\b/i);
        if (loseArmor) {
          const who = (loseArmor[1] || 'Opponent').toLowerCase() === 'player' ? 'player' : 'opponent';
          const amt = parseInt(loseArmor[2] || loseArmor[1], 10) || 0;
          base[who].armor = Math.max(0, base[who].armor - amt);
          if (i === index) base.event = { side: who, icon: 'assets/armor.png', text: `-${amt} armor` };
        }

        const dmg = t.match(/deals\s+(\d+)\s+damage/i);
        if (dmg) {
          const amt = parseInt(dmg[1], 10);
          // Heuristic: if line mentions Opponent deals, damage applies to Player, else to Opponent
          const toOpponent = /Player deals/i.test(t) || /Fighter deals/i.test(t);
          if (toOpponent) base.opponent.hp = Math.max(0, base.opponent.hp - amt); else base.player.hp = Math.max(0, base.player.hp - amt);
          if (i === index) base.event = { side: toOpponent ? 'opponent' : 'player', icon: 'assets/attack.png', text: `-${amt} HP` };
        }

        const gainSpeed = t.match(/(Player|Opponent) gains\s+(\d+)\s+speed/i);
        if (gainSpeed) {
          const who = gainSpeed[1].toLowerCase() === 'player' ? 'player' : 'opponent';
          const amt = parseInt(gainSpeed[2], 10);
          base[who].speed += amt; if (i === index) base.event = { side: who, icon: 'assets/speed.png', text: `+${amt} speed` };
        }

        const gainStatus = t.match(/(Player|Opponent) gains?\s+(\d+)\s+(acid|poison|regen|thorns)/i);
        if (gainStatus) {
          const who = gainStatus[1].toLowerCase() === 'player' ? 'player' : 'opponent';
          const amt = parseInt(gainStatus[2], 10);
          const key = gainStatus[3].toLowerCase();
          base[who].statuses[key] = (base[who].statuses[key] || 0) + amt;
          if (i === index) base.event = { side: who, icon: BattleIconRenderer.ICON_MAP[key] || 'assets/placeholder.png', text: `+${amt} ${key}` };
        }
      }
      return base;
    },

    renderState(state) {
      // Update core stats in both card and arena locations
      const setTextAll = (ids, v) => ids.forEach(id => { const el = document.getElementById(id); if (el) el.textContent = v; });
      setTextAll(['playerHP','arenaPlayerHP'], state.player.hp);
      setTextAll(['opponentHP','arenaOpponentHP'], state.opponent.hp);
      const playerAtk = Math.max(0, state.player.attack || 0);
      const opponentAtk = Math.max(0, state.opponent.attack || 0);
      setTextAll(['playerArmor','arenaPlayerArmor'], state.player.armor);
      setTextAll(['opponentArmor','arenaOpponentArmor'], state.opponent.armor);
      setTextAll(['playerAttack','arenaPlayerAttack'], playerAtk);
      setTextAll(['opponentAttack','arenaOpponentAttack'], opponentAtk);
      setTextAll(['playerSpeed','arenaPlayerSpeed'], state.player.speed);
      setTextAll(['opponentSpeed','arenaOpponentSpeed'], state.opponent.speed);

      // Render status chips
      const renderStatuses = (containerId, statuses, color) => {
        const box = document.getElementById(containerId);
        if (!box) return;
        box.innerHTML = '';
        const priority = ['stun','freeze','poison','acid','riptide','thorns','regen','purity','exposed'];
        const keys = Object.keys(statuses)
          .filter(k => (statuses[k]||0) > 0)
          .sort((a,b)=>{
            const ia = priority.indexOf(a); const ib = priority.indexOf(b);
            if (ia !== -1 || ib !== -1) return (ia===-1?99:ia) - (ib===-1?99:ib);
            return a.localeCompare(b);
          });
        if (keys.length === 0) return;
        keys.forEach(k => {
          const chip = document.createElement('div');
          chip.className = 'status-chip';
          chip.style.cssText = 'display:flex; align-items:center; gap:6px; background:#111; border:1px solid '+color+'; border-radius:6px; padding:4px 6px;';
          const img = document.createElement('img');
          img.src = BattleIconRenderer.ICON_MAP[k] || 'assets/placeholder.png';
          img.style.cssText = 'width:14px; height:14px; image-rendering:pixelated;';
          const span = document.createElement('span');
          const label = k.charAt(0).toUpperCase()+k.slice(1);
          span.textContent = `${label} ${statuses[k]}`;
          chip.appendChild(img); chip.appendChild(span); box.appendChild(chip);
        });
      };
      renderStatuses('playerStatusEffects', state.player.statuses, '#0f3');
      renderStatuses('opponentStatusEffects', state.opponent.statuses, '#f33');
      renderStatuses('arenaPlayerStatuses', state.player.statuses, '#0f3');
      renderStatuses('arenaOpponentStatuses', state.opponent.statuses, '#f33');

      // Render compact status bar (fixed set, includes zeros)
      const BAR = [
        ['freeze','sprites/Icon_freeze.png'],
        ['stun','sprites/Icon_stun.png'],
        ['poison','sprites/Icon_poison.png'],
        ['acid','sprites/Icon_acid.png'],
        ['riptide','sprites/Icon_riptide.png'],
        ['thorns','sprites/Icon_thorns.png'],
        ['regen','sprites/Icon_regen.png'],
        ['purity','sprites/Icon_purity.png']
      ];
      const renderStatusBar = (containerId, statuses, alignRight=false) => {
        const box = document.getElementById(containerId);
        if (!box) return;
        box.innerHTML = '';
        BAR.forEach(([key, icon])=>{
          const s = document.createElement('div'); s.className='s';
          const img = document.createElement('img'); img.src = icon; img.alt = key;
          const val = document.createElement('span'); val.textContent = (statuses && (statuses[key]|0)) || 0;
          s.appendChild(img); s.appendChild(val); box.appendChild(s);
        });
      };
      renderStatusBar('arenaPlayerStatusBar', state.player.statuses);
      renderStatusBar('arenaOpponentStatusBar', state.opponent.statuses, true);

      // Floating per-action overlay
      const showOverlayOne = (prefix, icon, text) => {
        const box = document.getElementById(prefix+'EventOverlay');
        const ic = document.getElementById(prefix+'EventIcon');
        const tx = document.getElementById(prefix+'EventText');
        if (!box || !ic || !tx) return;
        if (!text) { box.style.visibility = 'hidden'; return; }
        ic.src = icon; tx.textContent = text; box.style.visibility = 'visible';
        clearTimeout(box._t);
        box._t = setTimeout(()=>{ box.style.visibility = 'hidden'; }, 1200);
      };
      const showFor = (who) => {
        if (who === 'player') {
          showOverlayOne('player', state.event.icon, state.event.text);
          showOverlayOne('arenaPlayer', state.event.icon, state.event.text);
        } else if (who === 'opponent') {
          showOverlayOne('opponent', state.event.icon, state.event.text);
          showOverlayOne('arenaOpponent', state.event.icon, state.event.text);
        } else {
          showOverlayOne('player'); showOverlayOne('opponent');
          showOverlayOne('arenaPlayer'); showOverlayOne('arenaOpponent');
        }
      };
      showFor(state.event.side);
    },

    // Compute per-side deltas between two snapshots (all metrics)
    computeDeltas(prev, cur) {
      const collect = (who) => {
        const changes = [];
        if (!cur || !who) return changes;
        const P = prev && prev[who] ? prev[who] : null;
        const C = cur[who];
        const push = (key, from, to) => { const d = (to|0)-(from|0); if (d!==0) changes.push({ key, delta:d }); };
        push('hp', P?P.hp:0, C.hp);
        push('armor', P?P.armor:0, C.armor);
        // Attack we expose as atk; tempAtk not available in snapshot, so use attack only
        push('atk', P?P.attack:0, C.attack);
        push('speed', P?P.speed:0, C.speed);
        const keys = new Set([...(P&&P.statuses?Object.keys(P.statuses):[]), ...(C&&C.statuses?Object.keys(C.statuses):[])]);
        keys.forEach(k => push(k, P&&P.statuses?P.statuses[k]||0:0, C&&C.statuses?C.statuses[k]||0:0));
        return changes;
      };
      return { player: collect('player'), opponent: collect('opponent') };
    },

    renderDeltaList(containerId, list) {
      const box = document.getElementById(containerId);
      if (!box) return;
      box.innerHTML = '';
      if (!Array.isArray(list) || list.length===0) return;
      list.forEach(({key, delta}) => {
        const row = document.createElement('div');
        row.className = 'delta-row ' + (delta>0?'positive':'negative');
        const img = document.createElement('img'); img.className='icon'; img.src = this.deltaIcon(key);
        const val = document.createElement('b'); val.textContent = (delta>0?'+':'')+delta;
        const label = document.createElement('span'); label.className='label'; label.textContent = key==='atk'?'Attack': key==='hp'?'Health': key.charAt(0).toUpperCase()+key.slice(1);
        row.appendChild(img); row.appendChild(val); row.appendChild(label);
        box.appendChild(row);
      });
    },

    updateToIndex(index) {
      // Use full states for accurate deltas if available
      const prev = BattleStateManager.getFullState(Math.max(0, index-1));
      const cur  = BattleStateManager.getFullState(index);
      const state = this.computeState(index);
      this.renderState(state);
      if (cur) {
        const deltas = this.computeDeltas(prev, cur);
        this.renderDeltaList('arenaPlayerDelta', deltas.player);
        this.renderDeltaList('arenaOpponentDelta', deltas.opponent);
      } else {
        this.renderDeltaList('arenaPlayerDelta', []);
        this.renderDeltaList('arenaOpponentDelta', []);
      }

      // Action captions
      const entry = BattleStateManager.getLogEntry(index);
      const compact = (str) => {
        if (!str) return '';
        return String(str)
          .replace(/::icon:[^:]*::\s*/gi,'')
          .replace(/\beffect\b\s*/gi,'')
          .replace(/\s*\[PlayerHP:[^\]]*\]\s*$/i,'')
          .trim();
      };
      const txt = compact(entry && entry.text);
      const setText = (id, t) => { const el = document.getElementById(id); if (el) el.textContent = t || ''; };
      // Heuristic: if line mentions Player deals/gains etc, show under opponent or player appropriately
      if (/\bOpponent\b/i.test(txt) && !/\bPlayer\b/i.test(txt)) {
        setText('arenaOpponentAction', txt);
        setText('arenaPlayerAction', '');
      } else if (/\bPlayer\b/i.test(txt) && !/\bOpponent\b/i.test(txt)) {
        setText('arenaPlayerAction', txt);
        setText('arenaOpponentAction', '');
      } else {
        setText('arenaPlayerAction', txt);
        setText('arenaOpponentAction', txt);
      }
    }
  };
  </script>
  <script>
  /* Battle Replay System - State Manager Module */
  const BattleStateManager = {
  logEntries: [],
  stateSnapshots: [],
  fullStates: [],
  battleData: null,
  
  // Initialize with battle result data
  initBattle(simulationResult) {
    this.logEntries = [];
    this.stateSnapshots = [];
    this.battleData = simulationResult;
    // Attach full state snapshots if provided by the simulator hooks
    this.fullStates = Array.isArray(simulationResult.states) ? simulationResult.states : [];
    
    if (simulationResult.log && Array.isArray(simulationResult.log)) {
      // Process log entries into structured format
      simulationResult.log.forEach((line, index) => {
        if (line && line.trim()) {
          this.logEntries.push({
            index,
            text: line,
            type: this.classifyLogLine(line),
            hp: this.extractHPFromLine(line)
          });
        }
      });
    }
    
    // Create state snapshots (simplified for now)
    this.createStateSnapshots();
  },
  
  // Classify log line type for styling
  classifyLogLine(line) {
    const lineStr = String(line);
    if (lineStr.includes('   ') || lineStr.includes('BATTLE')) return 'major-divider';
    if (lineStr.match(/^\d+\.\s*--\s*Turn\s+\d+\s*--/)) return 'turn-header';
    if (lineStr.includes('Player') || lineStr.includes('Fighter')) return 'player';
    if (lineStr.includes('Opponent') || lineStr.includes('Enemy')) return 'opponent';
    return 'system';
  },
  
  // Extract HP information from log line
  extractHPFromLine(line) {
    const hpMatch = line.match(/\[PlayerHP:\s*(\d+)\s*\|\s*OpponentHP:\s*(\d+)\]/);
    if (hpMatch) {
      return {
        player: parseInt(hpMatch[1], 10),
        opponent: parseInt(hpMatch[2], 10)
      };
    }
    return null;
  },
  
  // Create state snapshots for each turn
  createStateSnapshots() {
    // For now, create simple snapshots
    // This could be enhanced to capture actual fighter states
    this.logEntries.forEach((entry, index) => {
      this.stateSnapshots.push({
        index,
        turnNumber: this.getTurnNumber(entry.text),
        hp: entry.hp,
        timestamp: Date.now()
      });
    });
  },

  // Get full per-line state if available (from simulator onState)
  getFullState(index) {
    return this.fullStates[index] || null;
  },
  
  // Extract turn number from log text
  getTurnNumber(text) {
    const turnMatch = text.match(/Turn\s+(\d+)/);
    return turnMatch ? parseInt(turnMatch[1], 10) : 0;
  },
  
  // Get log entry by index
  getLogEntry(index) {
    return this.logEntries[index] || null;
  },
  
  // Get state snapshot by index
  getStateSnapshot(index) {
    return this.stateSnapshots[index] || null;
  },
  
  // Get total number of entries
  getTotalEntries() {
    return this.logEntries.length;
  },
  
  // Check if battle data is loaded
  isLoaded() {
    return this.battleData !== null && this.logEntries.length > 0;
  }
  };
  try { window.BattleStateManager = BattleStateManager; } catch(_) {}
  </script>

<script>
  /* Battle Replay System - Replay Controller Module */
  const BattleReplayController = {
  currentIndex: 0,
  isPlaying: false,
  playbackSpeed: 1000, // ms between turns
  playbackTimer: null,
  elements: {},
  
  // Initialize replay controller
  init() {
    this.elements = {
      controls: document.getElementById('replayControls'),
      first: document.getElementById('replayFirst'),
      back: document.getElementById('replayBack'),
      play: document.getElementById('replayPlay'),
      forward: document.getElementById('replayForward'),
      last: document.getElementById('replayLast'),
      turnInput: document.getElementById('turnInput'),
      turnTotal: document.getElementById('turnTotal'),
      speedSelect: document.getElementById('replaySpeed'),
      log: document.getElementById('simLog')
    };
    
    this.setupEventListeners();
    this.hide();
  },
  
  // Setup event listeners for controls
  setupEventListeners() {
    if (!this.elements.first) return;
    
    this.elements.first.addEventListener('click', () => this.goToFirst());
    this.elements.back.addEventListener('click', () => this.stepBack());
    this.elements.play.addEventListener('click', () => this.togglePlayback());
    this.elements.forward.addEventListener('click', () => this.stepForward());
    this.elements.last.addEventListener('click', () => this.goToLast());
    
    this.elements.turnInput.addEventListener('change', () => this.goToTurn());
    this.elements.speedSelect.addEventListener('change', () => this.updateSpeed());
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => this.handleKeyboard(e));
  },
  
  // Handle keyboard shortcuts
  handleKeyboard(e) {
    if (!this.isVisible() || e.target.tagName === 'INPUT') return;
    
    switch(e.key) {
      case 'ArrowLeft':
        e.preventDefault();
        this.stepBack();
        break;
      case 'ArrowRight':
        e.preventDefault();
        this.stepForward();
        break;
      case ' ':
        e.preventDefault();
        this.togglePlayback();
        break;
      case 'Home':
        e.preventDefault();
        this.goToFirst();
        break;
      case 'End':
        e.preventDefault();
        this.goToLast();
        break;
    }
  },
  
  // Initialize replay with battle data
  loadBattle(simulationResult) {
    BattleStateManager.initBattle(simulationResult);
    
    if (!BattleStateManager.isLoaded()) {
      this.hide();
      return;
    }
    
    this.currentIndex = 0;
    this.updateTurnCounter();
    this.renderBattleLog();
    this.show();
    this.updateControls();
  },
  
  // Compact a raw log line for UI (strip noisy prefixes)
  compactLog(str){
    if (!str) return '';
    return String(str)
      .replace(/::icon:[^:]*::\s*/gi,'')
      .replace(/\beffect\b\s*/gi,'')
      .replace(/\s*\[PlayerHP:[^\]]*\]\s*$/i,'')
      .trim();
  },

  // Render the complete battle log with replay features
  renderBattleLog() {
    if (!this.elements.log) return;
    
    this.elements.log.innerHTML = '';
    const totalEntries = BattleStateManager.getTotalEntries();
    
    for (let i = 0; i < totalEntries; i++) {
      const entry = BattleStateManager.getLogEntry(i);
      if (!entry) continue;
      
      const div = document.createElement('div');
      div.className = `battle-log-line ${entry.type}`;
      div.dataset.index = i;
      div.textContent = this.compactLog(entry.text);
      
      // Add turn marker
      const marker = document.createElement('div');
      marker.className = 'turn-marker';
      div.appendChild(marker);
      
      // Add HP tracker if available
      if (entry.hp) {
        const hpTracker = document.createElement('span');
        hpTracker.className = 'hp-tracker';
        hpTracker.innerHTML = ` [P:${entry.hp.player} | O:${entry.hp.opponent}]`;
        div.appendChild(hpTracker);
      }
      
      // Add click listener for direct navigation
      div.addEventListener('click', () => this.goToIndex(i));
      
      // Render appropriate icon
      BattleIconRenderer.renderIcons(div, entry.text);
      
      this.elements.log.appendChild(div);
    }
    
    // Highlight current entry
    this.highlightCurrentEntry();
  },
  
  // Highlight the current log entry
  highlightCurrentEntry() {
    if (!this.elements.log) return;
    
    // Remove previous highlights
    const previous = this.elements.log.querySelectorAll('.battle-log-line.active');
    previous.forEach(el => el.classList.remove('active'));
    
    // Highlight current entry
    const current = this.elements.log.querySelector(`[data-index="${this.currentIndex}"]`);
    if (current) {
      current.classList.add('active');
      current.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  },
  
  // Navigation methods
  goToFirst() {
    this.currentIndex = 0;
    this.updateView();
  },
  
  goToLast() {
    this.currentIndex = Math.max(0, BattleStateManager.getTotalEntries() - 1);
    this.updateView();
  },
  
  stepBack() {
    if (this.currentIndex > 0) {
      this.currentIndex--;
      this.updateView();
    }
  },
  
  stepForward() {
    const total = BattleStateManager.getTotalEntries();
    if (this.currentIndex < total - 1) {
      this.currentIndex++;
      this.updateView();
    }
  },
  
  goToIndex(index) {
    const total = BattleStateManager.getTotalEntries();
    this.currentIndex = Math.max(0, Math.min(total - 1, index));
    this.updateView();
  },
  
  goToTurn() {
    const turnNumber = parseInt(this.elements.turnInput.value, 10) - 1;
    this.goToIndex(turnNumber);
  },
  
  // Playback control
  togglePlayback() {
    if (this.isPlaying) {
      this.stopPlayback();
    } else {
      this.startPlayback();
    }
  },
  
  startPlayback() {
    this.isPlaying = true;
    this.elements.play.textContent = '  ';
    this.elements.play.setAttribute('aria-label', 'Pause auto-play');
    
    this.playbackTimer = setInterval(() => {
      if (this.currentIndex >= BattleStateManager.getTotalEntries() - 1) {
        this.stopPlayback();
        return;
      }
      this.stepForward();
    }, this.playbackSpeed);
  },
  
  stopPlayback() {
    this.isPlaying = false;
    this.elements.play.textContent = '  ';
    this.elements.play.setAttribute('aria-label', 'Auto-play battle');
    
    if (this.playbackTimer) {
      clearInterval(this.playbackTimer);
      this.playbackTimer = null;
    }
  },
  
  updateSpeed() {
    this.playbackSpeed = parseInt(this.elements.speedSelect.value, 10);
    
    // Restart playback with new speed if currently playing
    if (this.isPlaying) {
      this.stopPlayback();
      this.startPlayback();
    }
  },
  
  // UI updates
    updateView() {
      this.highlightCurrentEntry();
      this.updateTurnCounter();
      this.updateControls();
      try { if (BattleVisuals) BattleVisuals.updateToIndex(this.currentIndex); } catch (_) {}
    },
  
  updateTurnCounter() {
    const total = BattleStateManager.getTotalEntries();
    this.elements.turnInput.value = this.currentIndex + 1;
    this.elements.turnInput.max = total;
    this.elements.turnTotal.textContent = `/ ${total}`;
  },
  
  updateControls() {
    const total = BattleStateManager.getTotalEntries();
    const isFirst = this.currentIndex === 0;
    const isLast = this.currentIndex >= total - 1;
    
    this.elements.first.disabled = isFirst;
    this.elements.back.disabled = isFirst;
    this.elements.forward.disabled = isLast;
    this.elements.last.disabled = isLast;
  },
  
  // Visibility control
  show() {
    if (this.elements.controls) {
      this.elements.controls.style.display = 'block';
    }
  },
  
  hide() {
    if (this.elements.controls) {
      this.elements.controls.style.display = 'none';
    }
    this.stopPlayback();
  },
  
  isVisible() {
    return this.elements.controls && 
           this.elements.controls.style.display !== 'none';
  },
  
  // Cleanup
  destroy() {
    this.stopPlayback();
    // Remove event listeners if needed
  }
  };
  try { window.BattleReplayController = BattleReplayController; } catch(_) {}
  </script>

  <!-- Scoped Side Logs Module -->
  <script>
    // Lightweight event structure and renderer fed by the master log
    window.SideLogs = {
      events: [],
      hideNoise: false,
      playerFilter: 'all',
      opponentFilter: 'all',
      // Public API
      loadFromLog(logArray) {
        try {
          this.events = this.parseEvents(Array.isArray(logArray) ? logArray : []);
          this.renderAll();
        } catch (e) { console.warn('SideLogs parse error:', e); }
      },
      setHideNoise(v) { this.hideNoise = !!v; this.renderAll(); },
      // Parse raw lines into structured events
      parseEvents(lines) {
        const out = [];
        const clean = (s) => String(s || '')
          .replace(/^::icon:[^:]*::\s*/i, '')
          .replace(/\s*\[.*?\]\s*$/,'')
          .trim();
        let tCounter = 0; // simple tick counter
        let currentTurn = 0;
        lines.forEach((raw, i) => {
          const text = clean(raw);
          if (!text) return;
          // Turn header
          const turnMatch = text.match(/--\s*Turn\s+(\d+)\s*--\s*(Player|Opponent)/i);
          if (turnMatch) {
            currentTurn = parseInt(turnMatch[1], 10) || currentTurn;
            out.push({ id: `t${i}`, turn: currentTurn, t: ++tCounter, kind: 'turn', actor: /Player/i.test(turnMatch[2]) ? 'player' : 'enemy', text });
            return;
          }
          // Attack variants
          let m;
          if ((m = text.match(/^(Player|Opponent).*?(?:hits|deals).*?(Player|Opponent).*?(\d+)/i))) {
            const actor = /Player/i.test(m[1]) ? 'player' : 'enemy';
            const target = /Player/i.test(m[2]) ? 'player' : 'enemy';
            const dmg = parseInt(m[3], 10) || undefined;
            out.push({ id: `a${i}` , turn: currentTurn, t: ++tCounter, kind: 'attack', actor, target, text, dmg: dmg ? -Math.abs(dmg) : undefined });
            return;
          }
          if ((m = text.match(/^(Player|Opponent).*?deals\s+(\d+)\s+damage/i))) {
            const actor = /Player/i.test(m[1]) ? 'player' : 'enemy';
            const dmg = parseInt(m[2], 10) || undefined;
            // Guess target as opposite of actor
            const target = actor === 'player' ? 'enemy' : 'player';
            out.push({ id: `d${i}`, turn: currentTurn, t: ++tCounter, kind: 'attack', actor, target, text, dmg: dmg ? -Math.abs(dmg) : undefined });
            return;
          }
          // Heal
          if ((m = text.match(/^(Player|Opponent).*?(?:restores|heals)\s+(\d+)\s+health/i))) {
            const actor = /Player/i.test(m[1]) ? 'player' : 'enemy';
            const amt = parseInt(m[2], 10) || 0;
            out.push({ id: `h${i}`, turn: currentTurn, t: ++tCounter, kind: 'heal', actor, target: actor, text, dmg: amt ? Math.abs(amt) : 0 });
            return;
          }
          // Armor +/-
          if ((m = text.match(/^(Player|Opponent).*?gains\s+(\d+)\s+armor/i))) {
            const actor = /Player/i.test(m[1]) ? 'player' : 'enemy';
            const amt = parseInt(m[2], 10) || 0;
            out.push({ id: `b${i}`, turn: currentTurn, t: ++tCounter, kind: 'buff', actor, target: actor, text, armor: Math.abs(amt) });
            return;
          }
          if ((m = text.match(/^(Player|Opponent).*?loses\s+(\d+)\s+armor/i))) {
            const actor = /Player/i.test(m[1]) ? 'player' : 'enemy';
            const amt = parseInt(m[2], 10) || 0;
            out.push({ id: `db${i}`, turn: currentTurn, t: ++tCounter, kind: 'debuff', actor, target: actor, text, armor: -Math.abs(amt) });
            return;
          }
          // Fallback info
          out.push({ id: `i${i}`, turn: currentTurn, t: ++tCounter, kind: 'info', actor: /Opponent/i.test(text) ? 'enemy' : 'player', text });
        });
        return out;
      },
      isNoiseText(text) {
        const t = (text||'').toLowerCase();
        return t.includes('tried to') || t.includes('had none to remove') || t.includes('already at') ||
               t.includes('no effect') || t.includes('misses') || /gains\s+0\b/.test(t) || /deals\s+0\s+damage/.test(t);
      },
      renderAll() { this.renderSide('player'); this.renderSide('enemy'); this.setupButtons(); },
      setupButtons() {
        const setActive = (btn, active) => { if (!btn) return; btn.style.background = active ? (btn.id.startsWith('player') ? '#002100' : '#210000') : '#000'; };
        const pAll = document.getElementById('playerFilterAll');
        const pOut = document.getElementById('playerFilterOutgoing');
        const pIn  = document.getElementById('playerFilterIncoming');
        if (pAll && !pAll._wired) { pAll._wired = true; pAll.addEventListener('click', ()=>{ this.playerFilter='all'; this.renderSide('player'); this.setupButtons(); }); }
        if (pOut && !pOut._wired) { pOut._wired = true; pOut.addEventListener('click', ()=>{ this.playerFilter='outgoing'; this.renderSide('player'); this.setupButtons(); }); }
        if (pIn  && !pIn._wired) { pIn._wired  = true; pIn.addEventListener('click', ()=>{ this.playerFilter='incoming'; this.renderSide('player'); this.setupButtons(); }); }
        const eAll = document.getElementById('opponentFilterAll');
        const eOut = document.getElementById('opponentFilterOutgoing');
        const eIn  = document.getElementById('opponentFilterIncoming');
        if (eAll && !eAll._wired) { eAll._wired = true; eAll.addEventListener('click', ()=>{ this.opponentFilter='all'; this.renderSide('enemy'); this.setupButtons(); }); }
        if (eOut && !eOut._wired) { eOut._wired = true; eOut.addEventListener('click', ()=>{ this.opponentFilter='outgoing'; this.renderSide('enemy'); this.setupButtons(); }); }
        if (eIn  && !eIn._wired) { eIn._wired  = true; eIn.addEventListener('click', ()=>{ this.opponentFilter='incoming'; this.renderSide('enemy'); this.setupButtons(); }); }
        setActive(pAll, this.playerFilter==='all'); setActive(pOut, this.playerFilter==='outgoing'); setActive(pIn, this.playerFilter==='incoming');
        setActive(eAll, this.opponentFilter==='all'); setActive(eOut, this.opponentFilter==='outgoing'); setActive(eIn, this.opponentFilter==='incoming');
      },
      renderSide(side) {
        const container = document.getElementById(side==='player' ? 'playerSideLogList' : 'opponentSideLogList');
        if (!container) return;
        const scope = side;
        const mode = side==='player' ? this.playerFilter : this.opponentFilter;
        const filtered = this.events.filter(e => {
          if (this.hideNoise && this.isNoiseText(e.text)) return false;
          if (!(e.actor === scope || e.target === scope)) return false; // relevant
          if (mode === 'outgoing') return e.actor === scope;
          if (mode === 'incoming') return e.target === scope;
          return true;
        });
        // Render
        container.innerHTML = '';
        if (filtered.length === 0) {
          container.innerHTML = '<div style="color:#888; text-align:center; padding:8px; font-style:italic;">No events</div>';
          return;
        }
        const ul = document.createElement('ul');
        ul.style.listStyle = 'none'; ul.style.margin = '0'; ul.style.padding = '0';
        filtered.forEach(e => {
          const li = document.createElement('li');
          li.style.padding = '4px 6px'; li.style.borderRadius = '6px'; li.style.display = 'flex'; li.style.alignItems = 'center'; li.style.gap = '6px';
          li.style.border = '1px solid rgba(255,255,255,0.06)'; li.style.marginBottom = '4px';
          const dot = document.createElement('span'); dot.style.display='inline-block'; dot.style.width='6px'; dot.style.height='6px'; dot.style.borderRadius='50%';
          const color = e.kind==='attack' ? (e.actor==='player'?'#0f3':'#f44') : e.kind==='turn' ? '#f0a' : e.kind==='heal' ? '#3fa' : e.kind==='buff' ? '#4af' : e.kind==='debuff' ? '#fa0' : '#999';
          dot.style.background = color; li.appendChild(dot);
          const meta = document.createElement('span'); meta.style.color='#777'; meta.style.fontSize='11px'; meta.textContent = `T${e.turn}.${e.t}`; li.appendChild(meta);
          const text = document.createElement('span'); text.style.flex='1'; text.textContent = e.text; li.appendChild(text);
          container.appendChild(li);
        });
      }
    };
  </script>

<script src="app.js"></script>

</body>
</html>





